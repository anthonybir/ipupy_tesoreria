<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPU PY Tesorería Nacional - Sistema Modernizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/absd-tokens.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/js/absd-components.js"></script>
    <script src="/js/absd-data-pipeline.js"></script>
    <script src="/js/absd-state-manager.js"></script>
    <script src="/js/absd-charts.js"></script>
    <script src="/js/absd-accessibility.js"></script>
    <!-- Google Sign-In Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-select-wrapper {
            padding: 0.75rem 0;
        }

        .tab-select {
            width: 100%;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background-color: #ffffff;
            color: #0f172a;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .tab-select:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
        }

        .tab-scroll-container {
            display: none;
        }

        @media (min-width: 768px) {
            .tab-select-wrapper {
                display: none;
            }

            .tab-scroll-container {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding: 0.5rem 0 0.75rem;
                scroll-snap-type: x mandatory;
            }

            .tab-scroll-container::-webkit-scrollbar {
                display: none;
            }
        }

        .tab-button {
            flex: 0 0 auto;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
            background-color: transparent;
            border-radius: 0.75rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            scroll-snap-align: start;
        }

        .tab-button:hover {
            color: #111827;
            background-color: #f3f4f6;
        }

        .tab-button.active {
            color: #2563eb;
            background-color: rgba(37, 99, 235, 0.1);
        }

        .tab-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }

        .step-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            border: 2px solid #d1d5db;
            background-color: #ffffff;
            color: #4b5563;
            transition: all 0.2s ease;
        }

        .step-btn:hover {
            background-color: #f9fafb;
        }

        .step-btn.active {
            border-color: #2563eb;
            background-color: #2563eb;
            color: #ffffff;
        }

        .step-btn.completed {
            border-color: #16a34a;
            background-color: #16a34a;
            color: #ffffff;
        }

        .step-number {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            background-color: currentColor;
            color: #ffffff;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-btn.active .step-number {
            background-color: #ffffff;
            color: #2563eb;
        }

        .step-btn.completed .step-number {
            background-color: #ffffff;
            color: #16a34a;
        }

        .preferences-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.18);
            color: #ffffff;
            font-size: 0.875rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .preferences-toggle:hover,
        .preferences-toggle:focus-visible {
            background-color: rgba(255, 255, 255, 0.28);
            outline: none;
        }

        .preferences-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.75rem;
            width: 18rem;
            background: #ffffff;
            color: #0f172a;
            border-radius: 1rem;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
            padding: 1rem;
            z-index: 60;
        }

        .preferences-panel h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .preferences-panel label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.25rem;
        }

        .preferences-panel select {
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.4);
            padding: 0.5rem 0.75rem;
            background-color: #ffffff;
            color: #0f172a;
            margin-bottom: 1rem;
        }

        .preferences-panel select:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
        }

        .preferences-panel.dark {
            background: rgba(15, 23, 42, 0.94);
            color: #E2E8F0;
            border-color: rgba(148, 163, 184, 0.2);
        }

        .preferences-panel.dark select {
            background: rgba(15, 23, 42, 0.9);
            color: #E2E8F0;
            border-color: rgba(148, 163, 184, 0.4);
        }

        .preferences-panel .panel-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .recent-report-item {
            border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        }

        .recent-report-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="min-h-screen theme-light density-normal absd-disclosure-basic">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="absd-container py-6 relative">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-2xl font-bold">IPU Paraguay</h1>
                    <p class="text-blue-100">Sistema Nacional de Tesorería</p>
                </div>
                <div class="flex items-center gap-3 self-end md:self-auto">
                    <button type="button" id="layoutSettingsToggle" class="preferences-toggle absd-focus-ring" aria-expanded="false" aria-controls="layoutSettingsPanel">
                        ⚙️ <span class="hidden sm:inline">Preferencias</span>
                    </button>
                    <div id="userInfo" class="hidden flex items-center gap-3">
                        <span id="userEmail" class="text-sm"></span>
                        <button onclick="logout()" class="bg-white/20 px-3 py-1 rounded hover:bg-white/30 transition text-sm">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
            <div id="layoutSettingsPanel" class="preferences-panel hidden" role="dialog" aria-modal="false" aria-labelledby="layoutSettingsTitle" aria-hidden="true" tabindex="-1">
                <h2 id="layoutSettingsTitle">Preferencias de vista</h2>
                <div class="space-y-4">
                    <div>
                        <label for="themePreference">Tema</label>
                        <select id="themePreference">
                            <option value="auto">Automático</option>
                            <option value="light">Claro</option>
                            <option value="dark">Oscuro</option>
                        </select>
                    </div>
                    <div>
                        <label for="densityPreference">Densidad</label>
                        <select id="densityPreference">
                            <option value="comfortable">Cómodo</option>
                            <option value="compact">Compacto</option>
                        </select>
                    </div>
                </div>
                <div class="panel-actions mt-2">
                    <button type="button" id="layoutSettingsClose" class="absd-btn absd-btn-ghost text-sm">Cerrar</button>
                    <button type="button" id="layoutSettingsApply" class="absd-btn absd-btn-primary text-sm">Aplicar</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Iniciar Sesión</h2>

            <!-- Google Sign-In Button -->
            <div class="mb-6">
                <div id="g_id_onload"
                     data-client_id="44786170581-apr8ukthgnp6dku7rkjh90kfruc2sf8t.apps.googleusercontent.com"
                     data-callback="handleGoogleLogin"
                     data-auto_prompt="false"
                     data-auto_select="false"
                     data-ux_mode="popup">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="signin_with"
                     data-shape="rectangular"
                     data-width="400"
                     data-locale="es">
                </div>

                <div class="text-center mt-3 text-xs text-gray-500">
                    Solo para cuentas @ipupy.org
                </div>
            </div>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">o usa email/contraseña</span>
                </div>
            </div>

            <form id="loginForm" class="absd-form-grid">
                <div class="absd-form-row">
                    <label for="loginEmail" class="absd-label">Email <span class="required-dot" aria-hidden="true">*</span></label>
                    <input type="email" id="loginEmail" required class="absd-input" autocomplete="email">
                </div>

                <div class="absd-form-row">
                    <label for="loginPassword" class="absd-label">Contraseña <span class="required-dot" aria-hidden="true">*</span></label>
                    <input type="password" id="loginPassword" required class="absd-input" autocomplete="current-password">
                </div>

                <button type="submit" class="absd-btn absd-btn-primary w-full justify-center">
                    <span id="loginText">Iniciar Sesión</span>
                    <div id="loginLoading" class="loading hidden ml-2" aria-hidden="true"></div>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">¿Primera vez?
                    <button onclick="showInitForm()" class="text-blue-600 hover:underline">Inicializar Sistema</button>
                </p>
            </div>

            <!-- Init Form -->
            <div id="initForm" class="hidden mt-4 p-4 bg-gray-50 rounded">
                <h3 class="font-semibold mb-3">Configuración Inicial</h3>
                <div class="absd-form-grid">
                    <div class="absd-form-row">
                        <label for="initEmail" class="absd-label">Email del administrador <span class="required-dot" aria-hidden="true">*</span></label>
                        <input type="email" id="initEmail" class="absd-input" placeholder="admin@ipupy.org" autocomplete="email">
                    </div>
                    <div class="absd-form-row">
                        <label for="initPassword" class="absd-label">Contraseña inicial <span class="required-dot" aria-hidden="true">*</span></label>
                        <input type="password" id="initPassword" class="absd-input" placeholder="Mínimo 6 caracteres" autocomplete="new-password" minlength="6">
                        <p class="absd-field-hint">Se utilizará para el primer ingreso del administrador.</p>
                    </div>
                    <button type="button" onclick="initSystem()" class="absd-btn absd-btn-primary w-full justify-center">
                        Inicializar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav id="navigation" class="bg-white shadow-sm border-b" aria-label="Navegación principal">
            <div class="absd-container">
                <div class="tab-select-wrapper md:hidden">
                    <label for="tabSelect" class="absd-sr-only">Seleccionar sección</label>
                    <select id="tabSelect" class="tab-select">
                        <option value="dashboard">Dashboard</option>
                        <option value="reports">Informes</option>
                        <option value="monthly-ledger">Libro Mensual</option>
                        <option value="transactions">Transacciones</option>
                        <option value="funds">Fondos</option>
                        <option value="churches">Iglesias</option>
                        <option value="export">Exportar</option>
                        <option value="dashboard-demo">Dashboard Demo (nueva pestaña)</option>
                    </select>
                </div>
                <div class="tab-scroll-container" role="tablist" aria-label="Secciones principales">
                    <button type="button" onclick="showTab('dashboard')" class="tab-button active" data-tab="dashboard" role="tab" aria-controls="dashboardTab" aria-selected="true" id="tab-dashboard">
                        📊 Dashboard
                    </button>
                    <button type="button" onclick="showTab('reports')" class="tab-button" data-tab="reports" role="tab" aria-controls="reportsTab" aria-selected="false" id="tab-reports">
                        📄 Informes
                    </button>
                    <button type="button" onclick="showTab('monthly-ledger')" class="tab-button" data-tab="monthly-ledger" role="tab" aria-controls="monthly-ledgerTab" aria-selected="false" id="tab-monthly-ledger">
                        📖 Libro Mensual
                    </button>
                    <button type="button" onclick="showTab('transactions')" class="tab-button" data-tab="transactions" role="tab" aria-controls="transactionsTab" aria-selected="false" id="tab-transactions">
                        💳 Transacciones
                    </button>
                    <button type="button" onclick="showTab('funds')" class="tab-button" data-tab="funds" role="tab" aria-controls="fundsTab" aria-selected="false" id="tab-funds">
                        💰 Fondos
                    </button>
                    <button type="button" onclick="showTab('churches')" class="tab-button" data-tab="churches" role="tab" aria-controls="churchesTab" aria-selected="false" id="tab-churches">
                        ⛪ Iglesias
                    </button>
                    <button type="button" onclick="showTab('export')" class="tab-button" data-tab="export" role="tab" aria-controls="exportTab" aria-selected="false" id="tab-export">
                        📥 Exportar
                    </button>
                </div>
                <div class="hidden md:flex justify-end pb-2">
                    <a href="/dashboard-demo.html" target="_blank" rel="noopener" class="tab-button" aria-label="Abrir demostración del dashboard en una nueva pestaña" style="text-decoration: none;">
                        🚀 Dashboard Demo
                    </a>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main id="main-content" class="absd-container py-6" role="main">
            <!-- Dashboard -->
            <div id="dashboardTab" class="tab-content" role="tabpanel" aria-labelledby="tab-dashboard" tabindex="0" aria-hidden="false">
                <div class="absd-grid mb-8" id="dashboardMetrics" role="list" aria-label="Métricas del dashboard">
                    <article class="absd-span-narrow bg-white rounded-lg shadow-sm border p-6" role="listitem" data-skeleton-type="metric" aria-label="Total de iglesias registradas">
                        <p class="text-sm text-gray-500 uppercase tracking-wide" id="label-total-churches">Total Iglesias</p>
                        <p id="totalChurches" class="text-3xl font-bold text-gray-900 number-morph metric-value" data-metric="total-churches" aria-labelledby="label-total-churches" aria-live="polite">0</p>
                    </article>
                    <article class="absd-span-narrow bg-white rounded-lg shadow-sm border p-6" role="listitem" data-skeleton-type="metric" aria-label="Iglesias que reportaron este mes">
                        <p class="text-sm text-gray-500 uppercase tracking-wide" id="label-reported-churches">Reportadas Este Mes</p>
                        <p id="reportedChurches" class="text-3xl font-bold text-green-600 number-morph metric-value" data-metric="reported-churches" aria-labelledby="label-reported-churches" aria-live="polite">0</p>
                    </article>
                    <article class="absd-span-narrow bg-white rounded-lg shadow-sm border p-6" role="listitem" data-skeleton-type="metric" aria-label="Total recaudado este mes en guaraníes">
                        <p class="text-sm text-gray-500 uppercase tracking-wide" id="label-month-total">Total Mes (Gs.)</p>
                        <p id="monthTotal" class="text-3xl font-bold text-blue-600 number-morph metric-value" data-metric="month-total" aria-labelledby="label-month-total" aria-live="polite">0</p>
                    </article>
                    <article class="absd-span-narrow bg-white rounded-lg shadow-sm border p-6" role="listitem" data-skeleton-type="metric" aria-label="Fondo nacional acumulado en guaraníes">
                        <p class="text-sm text-gray-500 uppercase tracking-wide" id="label-national-fund">Fondo Nacional (Gs.)</p>
                        <p id="nationalFund" class="text-3xl font-bold text-purple-600 number-morph metric-value" data-metric="national-fund" aria-labelledby="label-national-fund" aria-live="polite">0</p>
                    </article>
                </div>

                <!-- Recent Reports -->
                <section class="absd-span-full bg-white rounded-lg shadow-sm border p-6" aria-labelledby="recentReportsHeading">
                    <div class="flex items-center justify-between border-b border-gray-200 pb-4">
                        <h3 id="recentReportsHeading" class="text-lg font-semibold">Informes Recientes</h3>
                        <span class="text-xs text-gray-400" aria-live="polite" id="recentReportsStatus"></span>
                    </div>
                    <div id="recentReports" class="pt-6 space-y-4" role="list" aria-live="polite" data-skeleton-type="table">
                        <!-- Se llena dinámicamente -->
                    </div>
                </section>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-reports" aria-hidden="true" tabindex="0">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Gestión de Informes</h3>
                        <button onclick="openManualReportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Registrar Informe Manual
                        </button>
                    </div>
                    <div class="p-6">
                        <!-- Filtros -->
                        <form id="reportsFilterForm" class="absd-form-grid mb-6" onsubmit="filterReports(); return false;">
                            <div class="absd-form-row split-3">
                                <div>
                                    <label for="filterYear" class="absd-label">Año</label>
                                    <select id="filterYear" class="absd-select">
                                        <option value="">Todos los años</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterMonth" class="absd-label">Mes</label>
                                    <select id="filterMonth" class="absd-select">
                                        <option value="">Todos los meses</option>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="flex flex-col justify-end">
                                    <span class="absd-sr-only" id="reportsFilterButtonLabel">Aplicar filtro</span>
                                    <button type="submit" class="absd-btn absd-btn-primary w-full justify-center" aria-labelledby="reportsFilterButtonLabel">
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Lista de informes -->
                        <div id="reportsList" class="space-y-4">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Ledger Tab -->
            <div id="monthly-ledgerTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-monthly-ledger" aria-hidden="true" tabindex="0">
                <!-- Church Selection -->
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">Seleccionar Iglesia y Período</h3>
                    </div>
                    <div class="p-6">
                        <div class="absd-form-grid">
                            <div class="absd-form-row split-4">
                                <div>
                                    <label for="ledgerChurch" class="absd-label">Iglesia</label>
                                    <select id="ledgerChurch" class="absd-select">
                                        <option value="">Seleccionar Iglesia</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ledgerYear" class="absd-label">Año</label>
                                    <select id="ledgerYear" class="absd-select">
                                        <option value="">Año</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ledgerMonth" class="absd-label">Mes</label>
                                    <select id="ledgerMonth" class="absd-select">
                                        <option value="">Mes</option>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="flex flex-col justify-end">
                                    <span class="absd-sr-only" id="ledgerLoadLabel">Cargar período</span>
                                    <button type="button" onclick="loadMonthlyLedger()" class="absd-btn absd-btn-primary w-full justify-center" aria-labelledby="ledgerLoadLabel">
                                        Cargar Período
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Ledger Workflow -->
                <div id="monthlyLedgerContent" class="hidden">
                    <!-- Balance Overview Cards -->
                    <div class="absd-grid mb-6" role="list">
                        <article class="absd-card absd-density-target absd-span-minimal" role="listitem">
                            <p class="text-sm text-gray-500 uppercase tracking-wide">Total Entradas</p>
                            <p id="ledgerTotalEntradas" class="text-2xl font-bold text-green-600 number-morph">Gs. 0</p>
                        </article>
                        <article class="absd-card absd-density-target absd-span-minimal" role="listitem">
                            <p class="text-sm text-gray-500 uppercase tracking-wide">Fondo Nacional (10%)</p>
                            <p id="ledgerFondoNacional" class="text-2xl font-bold text-purple-600 number-morph">Gs. 0</p>
                        </article>
                        <article class="absd-card absd-density-target absd-span-minimal" role="listitem">
                            <p class="text-sm text-gray-500 uppercase tracking-wide">Disponible Local (90%)</p>
                            <p id="ledgerDisponibleLocal" class="text-2xl font-bold text-blue-600 number-morph">Gs. 0</p>
                        </article>
                        <article class="absd-card absd-density-target absd-span-minimal" role="listitem">
                            <p class="text-sm text-gray-500 uppercase tracking-wide">Total Gastos</p>
                            <p id="ledgerTotalGastos" class="text-2xl font-bold text-red-600 number-morph">Gs. 0</p>
                        </article>
                        <article class="absd-card absd-density-target absd-span-minimal" role="listitem">
                            <p class="text-sm text-gray-500 uppercase tracking-wide">Balance</p>
                            <p id="ledgerBalance" class="text-2xl font-bold number-morph">Gs. 0</p>
                        </article>
                    </div>

                    <!-- Step-by-Step Workflow -->
                    <div class="bg-white rounded-lg shadow-sm border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">Registro Mensual - <span id="ledgerPeriodTitle">Período</span></h3>
                            <div id="ledgerBalanceStatus" class="mt-2"></div>
                        </div>

                        <!-- Step Navigation -->
                        <div class="px-6 py-4 border-b bg-gray-50">
                            <div class="flex space-x-4">
                                <button id="stepCultosBtn" onclick="showLedgerStep(1)" class="step-btn active">
                                    <span class="step-number">1</span>
                                    Registrar Cultos
                                </button>
                                <button id="stepGastosBtn" onclick="showLedgerStep(2)" class="step-btn">
                                    <span class="step-number">2</span>
                                    Registrar Gastos
                                </button>
                                <button id="stepCierreBtn" onclick="showLedgerStep(3)" class="step-btn">
                                    <span class="step-number">3</span>
                                    Revisión y Cierre
                                </button>
                            </div>
                        </div>

                        <!-- Step 1: Registrar Cultos -->
                        <div id="ledgerStep1" class="step-content p-6">
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-4">Paso 1: Registrar Cultos y Contribuciones</h4>
                                <p class="text-gray-600 mb-4">Registre cada culto del mes con las contribuciones individuales de los miembros.</p>

                                <button onclick="openWorshipRecordModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4">
                                    + Agregar Culto
                                </button>
                            </div>

                            <!-- Worship Records List -->
                            <div id="worshipRecordsList" class="space-y-4">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>

                        <!-- Step 2: Registrar Gastos -->
                        <div id="ledgerStep2" class="step-content p-6 hidden">
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-4">Paso 2: Registrar Gastos del Mes</h4>
                                <p class="text-gray-600 mb-4">Registre todos los gastos de la iglesia con sus respectivas facturas.</p>

                                <div class="flex gap-2 mb-4">
                                    <button onclick="openExpenseModal('servicios_basicos', 'ANDE')" class="bg-yellow-600 text-white px-3 py-2 rounded hover:bg-yellow-700 text-sm">
                                        + ANDE
                                    </button>
                                    <button onclick="openExpenseModal('servicios_basicos', 'ESSAP')" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm">
                                        + ESSAP
                                    </button>
                                    <button onclick="openExpenseModal('servicios_basicos', 'Basura')" class="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 text-sm">
                                        + Basura
                                    </button>
                                    <button onclick="openExpenseModal('otros', '')" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm">
                                        + Otro Gasto
                                    </button>
                                </div>
                            </div>

                            <!-- Expenses List -->
                            <div id="expenseRecordsList" class="space-y-4">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>

                        <!-- Step 3: Revisión y Cierre -->
                        <div id="ledgerStep3" class="step-content p-6 hidden">
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-4">Paso 3: Revisión y Cierre del Mes</h4>
                                <p class="text-gray-600 mb-4">Revise los totales y proceda al cierre oficial del período.</p>
                            </div>

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- Income Summary -->
                                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                                    <h5 class="font-semibold text-green-800 mb-4">📈 Resumen de Entradas</h5>
                                    <div id="incomeSummary" class="space-y-2 text-sm">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                </div>

                                <!-- Expense Summary -->
                                <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                                    <h5 class="font-semibold text-red-800 mb-4">📉 Resumen de Gastos</h5>
                                    <div id="expenseSummary" class="space-y-2 text-sm">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- National Fund Distribution -->
                            <div class="bg-purple-50 p-6 rounded-lg border border-purple-200 mb-6">
                                <h5 class="font-semibold text-purple-800 mb-4">🏛️ Distribución Automática del Fondo Nacional</h5>
                                <div id="nationalFundSummary" class="space-y-2 text-sm">
                                    <!-- Se llena dinámicamente -->
                                </div>
                            </div>

                            <!-- Pastor Salary Section -->
                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 mb-6">
                                <h5 class="font-semibold text-blue-800 mb-4">💼 Salario Pastoral</h5>
                                <div id="pastorSalarySummary" class="space-y-2">
                                    <!-- Se llena dinámicamente -->
                                </div>
                                <div id="generateInvoiceSection" class="mt-4 hidden">
                                    <button onclick="generatePastorInvoice()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                        Generar Factura Pastoral
                                    </button>
                                </div>
                            </div>

                            <!-- Final Balance and Close Actions -->
                            <div class="bg-gray-50 p-6 rounded-lg border">
                                <div class="flex justify-between items-center mb-4">
                                    <h5 class="font-semibold text-gray-800">Estado Final del Mes</h5>
                                    <div id="finalBalanceDisplay" class="text-2xl font-bold">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                </div>

                                <div id="closureActions" class="flex gap-4">
                                    <button id="closeMonthBtn" onclick="closeMonth()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                                        Cerrar Mes
                                    </button>
                                    <button onclick="exportMonthlyReport()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                        Exportar Reporte
                                    </button>
                                </div>

                                <div id="closureMessages" class="mt-4">
                                    <!-- Mensajes de validación -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactionsTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-transactions" aria-hidden="true" tabindex="0">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Registro de Transacciones</h3>
                        <button onclick="openTransactionModal()" class="absd-btn absd-btn-primary flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nueva Transacción
                        </button>
                    </div>
                    <div class="p-6">
                        <!-- Filters -->
                        <div class="absd-card absd-form-grid mb-6" data-skeleton-type="table">
                            <div class="absd-form-row split-4">
                                <div>
                                    <label for="filterTransactionFund" class="absd-label">Fondo</label>
                                    <select id="filterTransactionFund" class="absd-select">
                                        <option value="">Todos los fondos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterTransactionChurch" class="absd-label">Iglesia</label>
                                    <select id="filterTransactionChurch" class="absd-select">
                                        <option value="">Todas las iglesias</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterTransactionDateFrom" class="absd-label">Desde</label>
                                    <input type="date" id="filterTransactionDateFrom" class="absd-input" placeholder="Fecha desde">
                                </div>
                                <div>
                                    <label class="absd-label">&#8203;</label>
                                    <button onclick="filterTransactions()" class="absd-btn absd-btn-primary">
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction List -->
                        <div id="transactionsListContainer" class="absd-virtual-panel" data-skeleton-type="table" aria-live="polite">
                            <div class="absd-virtual-table-header absd-virtual-table-header--transactions" role="row">
                                <span role="columnheader">Fecha</span>
                                <span role="columnheader">Iglesia</span>
                                <span role="columnheader">Fondo</span>
                                <span role="columnheader">Concepto</span>
                                <span role="columnheader">Proveedor</span>
                                <span role="columnheader">Documento</span>
                                <span role="columnheader">Entrada</span>
                                <span role="columnheader">Salida</span>
                                <span role="columnheader">Saldo</span>
                                <span role="columnheader">Acciones</span>
                            </div>
                            <div id="transactionsVirtualList" class="absd-virtual-scroll" role="table" aria-label="Historial de transacciones registradas">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funds Tab -->
            <div id="fundsTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-funds" aria-hidden="true" tabindex="0">
                <!-- Fund Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 uppercase tracking-wide">Total Fondos</div>
                        <div id="totalFunds" class="text-3xl font-bold text-gray-900">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 uppercase tracking-wide">Saldo Total (Gs.)</div>
                        <div id="totalBalance" class="text-3xl font-bold text-green-600">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 uppercase tracking-wide">Fondos Activos</div>
                        <div id="activeFunds" class="text-3xl font-bold text-blue-600">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 uppercase tracking-wide">Movimientos Hoy</div>
                        <div id="todayMovements" class="text-3xl font-bold text-purple-600">0</div>
                    </div>
                </div>

                <!-- Fund List -->
                <div class="bg-white rounded-lg shadow-sm border mb-6">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Gestión de Fondos</h3>
                        <button onclick="openNewFundModal()" class="absd-btn absd-btn-primary">
                            Nuevo Fondo
                        </button>
                    </div>
                    <div class="p-6">
                        <div id="fundsListContainer" class="absd-virtual-panel" data-skeleton-type="table" aria-live="polite">
                            <div class="absd-virtual-table-header absd-virtual-table-header--funds" role="row">
                                <span role="columnheader">Fondo</span>
                                <span role="columnheader">Tipo</span>
                                <span role="columnheader">Saldo Actual</span>
                                <span role="columnheader">Última Actualización</span>
                                <span role="columnheader">Estado</span>
                                <span role="columnheader">Acciones</span>
                            </div>
                            <div id="fundsVirtualList" class="absd-virtual-scroll" role="table" aria-label="Fondos administrados">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fund Movements History -->
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">Historial de Movimientos</h3>
                        <div class="mt-4 absd-form-grid">
                            <div class="absd-form-row split-4">
                                <div>
                                    <label for="movementsFundFilter" class="absd-label">Fondo</label>
                                    <select id="movementsFundFilter" class="absd-select">
                                        <option value="">Todos los fondos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="movementsDateFrom" class="absd-label">Desde</label>
                                    <input type="date" id="movementsDateFrom" class="absd-input" placeholder="Desde">
                                </div>
                                <div>
                                    <label for="movementsDateTo" class="absd-label">Hasta</label>
                                    <input type="date" id="movementsDateTo" class="absd-input" placeholder="Hasta">
                                </div>
                                <div>
                                    <label class="absd-label">&#8203;</label>
                                    <button onclick="filterFundMovements()" class="absd-btn absd-btn-primary">
                                        Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="fundMovementsListContainer" class="absd-virtual-panel" data-skeleton-type="table" aria-live="polite">
                            <div class="absd-virtual-table-header absd-virtual-table-header--fund-movements" role="row">
                                <span role="columnheader">Fecha</span>
                                <span role="columnheader">Fondo</span>
                                <span role="columnheader">Concepto</span>
                                <span role="columnheader">Saldo Anterior</span>
                                <span role="columnheader">Movimiento</span>
                                <span role="columnheader">Saldo Nuevo</span>
                            </div>
                            <div id="fundMovementsVirtualList" class="absd-virtual-scroll" role="table" aria-label="Historial de movimientos de fondos">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Churches Tab -->
            <div id="churchesTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-churches" aria-hidden="true" tabindex="0">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Gestión de Iglesias</h3>
                            <button onclick="openNewChurchModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Nueva Iglesia
                            </button>
                        </div>
                    </div>
                    <!-- Search and Filter -->
                    <div class="p-6 border-b bg-gray-50">
                        <div class="flex gap-4">
                            <input type="text" id="churchSearch" class="flex-1 px-3 py-2 border rounded"
                                   placeholder="Buscar iglesia, pastor o ciudad...">
                            <select id="churchStatusFilter" class="px-3 py-2 border rounded">
                                <option value="">Todos los estados</option>
                                <option value="true">Activas</option>
                                <option value="false">Inactivas</option>
                            </select>
                            <button onclick="filterChurches()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                                Filtrar
                            </button>
                        </div>
                    </div>
                    <div id="churchesList" class="p-6">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="exportTab" class="tab-content hidden" role="tabpanel" aria-labelledby="tab-export" aria-hidden="true" tabindex="0">
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold">Exportar Datos a Excel</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Exportar Informe Mensual -->
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold mb-3">Informe Mensual</h4>
                                <div class="space-y-3">
                                    <select id="exportYear" class="w-full px-3 py-2 border rounded">
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                    </select>
                                    <select id="exportMonth" class="w-full px-3 py-2 border rounded">
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                    <button onclick="exportData('monthly')"
                                            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                                        Exportar Mes
                                    </button>
                                </div>
                            </div>

                            <!-- Exportar Resumen Anual -->
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold mb-3">Resumen Anual</h4>
                                <div class="space-y-3">
                                    <select id="exportYearlyYear" class="w-full px-3 py-2 border rounded">
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                    </select>
                                    <button onclick="exportData('yearly')"
                                            class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                                        Exportar Año
                                    </button>
                                </div>
                            </div>

                            <!-- Exportar Lista de Iglesias -->
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold mb-3">Lista de Iglesias</h4>
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-600">Exportar lista completa de iglesias con información de pastores.</p>
                                    <button onclick="exportData('churches')"
                                            class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">
                                        Exportar Iglesias
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Manual Report Entry Modal -->
    <div id="manualReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Registrar Informe Manual</h3>
                    <button onclick="closeManualReportModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="manualReportForm" class="p-6">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Iglesia</label>
                            <select id="manualChurchId" class="w-full px-3 py-2 border rounded" required>
                                <option value="">Seleccionar iglesia...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Año</label>
                            <input type="number" id="manualYear" class="w-full px-3 py-2 border rounded"
                                   min="2020" max="2030" value="2025" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Mes</label>
                            <select id="manualMonth" class="w-full px-3 py-2 border rounded" required>
                                <option value="">Seleccionar mes...</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                    </div>

                    <!-- ENTRADAS DEL MES -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-lg mb-3 text-blue-800">ENTRADAS DEL MES</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Diezmos (Gs.)</label>
                                <input type="number" id="manualDiezmos" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Ofrendas (Gs.)</label>
                                <input type="number" id="manualOfrendas" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Anexos (Gs.)</label>
                                <input type="number" id="manualAnexos" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Caballeros (Gs.)</label>
                                <input type="number" id="manualCaballeros" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Damas (Gs.)</label>
                                <input type="number" id="manualDamas" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Jóvenes (Gs.)</label>
                                <input type="number" id="manualJovenes" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Niños (Gs.)</label>
                                <input type="number" id="manualNinos" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Otros (Gs.)</label>
                                <input type="number" id="manualOtros" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- OFRENDAS DIRECTAS - FONDO NACIONAL -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-lg mb-3 text-green-800">OFRENDAS DIRECTAS - FONDO NACIONAL</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Ofrenda de Misiones (Gs.)</label>
                                <input type="number" id="manualOfrendaDirectasMisiones" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Lazos de Amor (Gs.)</label>
                                <input type="number" id="manualLazosAmor" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Misión Posible (Gs.)</label>
                                <input type="number" id="manualMisionPosible" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Aporte Caballeros (Gs.)</label>
                                <input type="number" id="manualAporteCaballeros" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">APY (Gs.)</label>
                                <input type="number" id="manualApy" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Instituto Bíblico (Gs.)</label>
                                <input type="number" id="manualInstitutoBiblico" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Diezmo Pastoral (Gs.)</label>
                                <input type="number" id="manualDiezmoPastoral" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- DEPOSIT INFO -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-lg mb-3 text-purple-800">INFORMACIÓN DE DEPÓSITO</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Fecha de Depósito</label>
                                <input type="date" id="manualFechaDeposito" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Número de Boleta</label>
                                <input type="text" id="manualNumeroDeposito" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Monto Depositado (Gs.)</label>
                                <input type="number" id="manualMontoDepositado" class="w-full px-3 py-2 border rounded" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- ATTENDANCE & BAPTISMS -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-lg mb-3 text-orange-800">ASISTENCIAS Y BAUTISMOS</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Asistencia de Visitas</label>
                                <input type="number" id="manualAsistenciaVisitas" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Bautismos en Agua</label>
                                <input type="number" id="manualBautismosAgua" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Bautismos Espíritu Santo</label>
                                <input type="number" id="manualBautismosEspiritu" class="w-full px-3 py-2 border rounded">
                            </div>
                        </div>
                    </div>

                    <!-- OBSERVACIONES -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Observaciones</label>
                        <textarea id="manualObservaciones" class="w-full px-3 py-2 border rounded" rows="3"
                                  placeholder="Observaciones adicionales..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeManualReportModal()"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Guardar Informe
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Nueva Transacción</h3>
                    <button onclick="closeTransactionModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="transactionForm" class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Fecha *</label>
                            <input type="date" id="transactionDate" class="w-full px-3 py-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Fondo *</label>
                            <select id="transactionFund" class="w-full px-3 py-2 border rounded" required>
                                <option value="">Seleccionar fondo...</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Iglesia (opcional)</label>
                            <select id="transactionChurch" class="w-full px-3 py-2 border rounded">
                                <option value="">Seleccionar iglesia...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Concepto *</label>
                            <input type="text" id="transactionConcept" class="w-full px-3 py-2 border rounded"
                                   placeholder="Descripción de la transacción" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Proveedor</label>
                            <input type="text" id="transactionProvider" class="w-full px-3 py-2 border rounded"
                                   placeholder="Nombre del proveedor">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Número de Documento</label>
                            <input type="text" id="transactionDocument" class="w-full px-3 py-2 border rounded"
                                   placeholder="Factura, recibo, etc.">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Entrada (Gs.)</label>
                            <input type="number" id="transactionAmountIn" class="w-full px-3 py-2 border rounded"
                                   step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Salida (Gs.)</label>
                            <input type="number" id="transactionAmountOut" class="w-full px-3 py-2 border rounded"
                                   step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Especifique SOLO entrada O salida, no ambos.</p>

                    <div class="flex items-center justify-between border-t pt-4">
                        <button type="button" id="addTransactionEntryBtn"
                                class="px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            Agregar partida
                        </button>
                        <div class="flex gap-2">
                            <button type="button" onclick="closeTransactionModal()"
                                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="button" id="saveTransactionBatchBtn"
                                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Registrar partidas
                            </button>
                        </div>
                    </div>

                    <div id="transactionEntriesContainer" class="hidden">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Partidas agregadas</h4>
                        <div class="overflow-x-auto border rounded">
                            <table class="min-w-full divide-y divide-gray-200 text-sm" role="table" aria-label="Partidas de transacción preparadas">
                                <caption class="absd-sr-only">Partidas temporales antes de registrar una nueva transacción</caption>
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Fecha</th>
                                        <th class="px-4 py-2 text-left">Fondo</th>
                                        <th class="px-4 py-2 text-left">Concepto</th>
                                        <th class="px-4 py-2 text-right">Entrada</th>
                                        <th class="px-4 py-2 text-right">Salida</th>
                                        <th class="px-4 py-2 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionEntriesTable" class="divide-y divide-gray-200">
                                    <!-- Items dinámicos -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden z-50">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 min-w-80">
            <div class="flex items-center">
                <div id="toastIcon" class="mr-3"></div>
                <div>
                    <div id="toastTitle" class="font-semibold"></div>
                    <div id="toastMessage" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Fund Modal -->
    <div id="fundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Nuevo Fondo</h3>
                    <button onclick="closeFundModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="fundForm" class="p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre del Fondo *</label>
                            <input type="text" id="fundName" class="w-full px-3 py-2 border rounded"
                                   placeholder="Ej: Fondo Nacional, Construcción Templo, etc." required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Tipo de Fondo *</label>
                            <select id="fundType" class="w-full px-3 py-2 border rounded" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="national">Nacional</option>
                                <option value="restricted">Restringido/Especial</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Descripción</label>
                            <textarea id="fundDescription" class="w-full px-3 py-2 border rounded" rows="3"
                                      placeholder="Descripción opcional del propósito del fondo"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Saldo Inicial (Gs.)</label>
                            <input type="number" id="fundInitialBalance" class="w-full px-3 py-2 border rounded"
                                   value="0" min="0" step="1">
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="fundActive" class="mr-2" checked>
                            <label for="fundActive" class="text-sm">Fondo activo</label>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-6 mt-6 border-t">
                        <button type="button" onclick="closeFundModal()"
                                class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Crear Fondo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Church Modal -->
    <div id="churchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="churchModalTitle" class="text-lg font-semibold">Nueva Iglesia</h3>
                    <button onclick="closeChurchModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="churchForm" class="p-6">
                    <input type="hidden" id="churchId" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre de la Iglesia *</label>
                            <input type="text" id="churchName" class="w-full px-3 py-2 border rounded"
                                   placeholder="Ej: IPU ASUNCIÓN" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Ciudad *</label>
                            <input type="text" id="churchCity" class="w-full px-3 py-2 border rounded"
                                   placeholder="Ej: Asunción" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Pastor *</label>
                            <input type="text" id="churchPastor" class="w-full px-3 py-2 border rounded"
                                   placeholder="Nombre completo del pastor" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Teléfono</label>
                            <input type="text" id="churchPhone" class="w-full px-3 py-2 border rounded"
                                   placeholder="Número de teléfono">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Cédula</label>
                            <input type="text" id="churchCedula" class="w-full px-3 py-2 border rounded"
                                   placeholder="Cédula del pastor">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">RUC</label>
                            <input type="text" id="churchRuc" class="w-full px-3 py-2 border rounded"
                                   placeholder="RUC del pastor">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Grado Ministerial</label>
                            <input type="text" id="churchGrado" class="w-full px-3 py-2 border rounded"
                                   placeholder="Ej: Reverendo, Pastor, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Posición</label>
                            <input type="text" id="churchPosicion" class="w-full px-3 py-2 border rounded"
                                   placeholder="Ej: Pastor Principal, Asistente, etc.">
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="churchActive" class="mr-2" checked>
                                <span class="text-sm">Iglesia activa</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeChurchModal()"
                                class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Crear Iglesia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let currentTab = 'dashboard';

        const LAYOUT_PREF_KEY = 'absdLayoutPreferences';
        const TAB_PREF_KEY = 'absdCurrentTab';
        const DEFAULT_LAYOUT_PREFS = { theme: 'auto', density: 'comfortable' };
        const AVAILABLE_TABS = ['dashboard', 'reports', 'monthly-ledger', 'transactions', 'funds', 'churches', 'export'];
        const THEME_CLASSES = ['theme-light', 'theme-dark'];
        const DENSITY_CLASSES = ['density-comfortable', 'density-compact'];
        const DASHBOARD_METRIC_IDS = ['totalChurches', 'reportedChurches', 'monthTotal', 'nationalFund'];
        const themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        let layoutPrefs = loadLayoutPreferences();

        const storedTab = localStorage.getItem(TAB_PREF_KEY);
        if (storedTab && AVAILABLE_TABS.includes(storedTab)) {
            currentTab = storedTab;
        }

        const FUND_BUCKETS = [
            { value: 'diezmo', label: 'Diezmo', group: 'national10' },
            { value: 'ofrenda', label: 'Ofrenda', group: 'national10' },
            { value: 'misiones', label: 'Misiones', group: 'national100' },
            { value: 'lazos_amor', label: 'Lazos de Amor', group: 'national100' },
            { value: 'mision_posible', label: 'Misión Posible', group: 'national100' },
            { value: 'apy', label: 'APY', group: 'national100' },
            { value: 'instituto_biblico', label: 'Instituto Bíblico', group: 'national100' },
            { value: 'diezmo_pastoral', label: 'Diezmo Pastoral', group: 'national100' },
            { value: 'caballeros', label: 'Caballeros', group: 'national100' },
            { value: 'damas', label: 'Damas', group: 'local' },
            { value: 'jovenes', label: 'Jóvenes', group: 'local' },
            { value: 'ninos', label: 'Niños', group: 'local' },
            { value: 'anexos', label: 'Anexos', group: 'local' },
            { value: 'otros', label: 'Otros', group: 'local' }
        ];
        const FUND_OPTIONS_HTML = FUND_BUCKETS
            .map(({ value, label }) => `<option value="${value}">${label}</option>`)
            .join('');

        const storedUserJson = localStorage.getItem('currentUser');
        if (storedUserJson) {
            try {
                currentUser = JSON.parse(storedUserJson);
            } catch (error) {
                console.warn('No se pudo parsear currentUser almacenado:', error);
                localStorage.removeItem('currentUser');
            }
        }

        function loadLayoutPreferences() {
            const stored = localStorage.getItem(LAYOUT_PREF_KEY);
            if (!stored) {
                return { ...DEFAULT_LAYOUT_PREFS };
            }
            try {
                const parsed = JSON.parse(stored);
                return { ...DEFAULT_LAYOUT_PREFS, ...parsed };
            } catch (error) {
                console.warn('Preferencias de diseño inválidas, se restablecen a valores por defecto', error);
                localStorage.removeItem(LAYOUT_PREF_KEY);
                return { ...DEFAULT_LAYOUT_PREFS };
            }
        }

        function resolveTheme(themeSetting) {
            if (themeSetting === 'dark' || themeSetting === 'light') {
                return themeSetting;
            }
            return themeMediaQuery.matches ? 'dark' : 'light';
        }

        function applyLayoutPreferences(prefs = {}, options = {}) {
            layoutPrefs = { ...layoutPrefs, ...prefs };

            if (options.save) {
                localStorage.setItem(LAYOUT_PREF_KEY, JSON.stringify(layoutPrefs));
            }

            const resolvedTheme = resolveTheme(layoutPrefs.theme);
            document.body.classList.remove(...THEME_CLASSES);
            document.body.classList.add(resolvedTheme === 'dark' ? 'theme-dark' : 'theme-light');

            document.body.classList.remove(...DENSITY_CLASSES);
            document.body.classList.add(layoutPrefs.density === 'compact' ? 'density-compact' : 'density-comfortable');

            const panel = document.getElementById('layoutSettingsPanel');
            if (panel) {
                panel.classList.toggle('dark', resolvedTheme === 'dark');
            }

            syncPreferenceUI();

            if (options.closePanel) {
                hideLayoutPanel();
            }
        }

        function syncPreferenceUI() {
            const themeSelect = document.getElementById('themePreference');
            const densitySelect = document.getElementById('densityPreference');

            if (themeSelect && themeSelect.value !== layoutPrefs.theme) {
                themeSelect.value = layoutPrefs.theme;
            }

            if (densitySelect && densitySelect.value !== layoutPrefs.density) {
                densitySelect.value = layoutPrefs.density;
            }
        }

        function isLayoutPanelOpen() {
            const panel = document.getElementById('layoutSettingsPanel');
            return panel ? !panel.classList.contains('hidden') : false;
        }

        function showLayoutPanel() {
            const panel = document.getElementById('layoutSettingsPanel');
            const toggle = document.getElementById('layoutSettingsToggle');
            if (!panel || !toggle) return;
            syncPreferenceUI();
            panel.classList.remove('hidden');
            panel.setAttribute('aria-hidden', 'false');
            toggle.setAttribute('aria-expanded', 'true');
            panel.focus();
        }

        function hideLayoutPanel() {
            const panel = document.getElementById('layoutSettingsPanel');
            const toggle = document.getElementById('layoutSettingsToggle');
            if (!panel || !toggle) return;
            panel.classList.add('hidden');
            panel.setAttribute('aria-hidden', 'true');
            toggle.setAttribute('aria-expanded', 'false');
        }

        function toggleLayoutPanel() {
            if (isLayoutPanelOpen()) {
                hideLayoutPanel();
            } else {
                showLayoutPanel();
            }
        }

        function handleTabSelectChange(event) {
            const { value } = event.target;
            if (value === 'dashboard-demo') {
                window.open('/dashboard-demo.html', '_blank', 'noopener');
                event.target.value = currentTab;
                return;
            }
            showTab(value);
        }

        function handleTabKeyDown(event) {
            const keys = ['ArrowRight', 'ArrowLeft', 'Home', 'End'];
            if (!keys.includes(event.key)) {
                return;
            }

            const buttons = Array.from(document.querySelectorAll('.tab-button'));
            const currentIndex = buttons.indexOf(event.currentTarget);
            if (currentIndex === -1) {
                return;
            }

            let nextIndex = currentIndex;
            if (event.key === 'ArrowRight') {
                nextIndex = (currentIndex + 1) % buttons.length;
            } else if (event.key === 'ArrowLeft') {
                nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
            } else if (event.key === 'Home') {
                nextIndex = 0;
            } else if (event.key === 'End') {
                nextIndex = buttons.length - 1;
            }

            event.preventDefault();
            const targetButton = buttons[nextIndex];
            if (targetButton) {
                targetButton.focus();
                const tabName = targetButton.dataset.tab;
                if (tabName) {
                    showTab(tabName);
                }
            }
        }

        function setDashboardLoading(isLoading) {
            DASHBOARD_METRIC_IDS.forEach(id => {
                const metricEl = document.getElementById(id);
                if (!metricEl) return;
                if (isLoading) {
                    metricEl.classList.add('absd-skeleton-value');
                    metricEl.setAttribute('aria-busy', 'true');
                } else {
                    metricEl.classList.remove('absd-skeleton-value');
                    metricEl.removeAttribute('aria-busy');
                }
            });

            const statusEl = document.getElementById('recentReportsStatus');
            if (statusEl && isLoading) {
                statusEl.textContent = 'Cargando datos del dashboard…';
            }
        }

        function renderRecentReportsSkeleton() {
            const container = document.getElementById('recentReports');
            if (!container) return;

            container.innerHTML = Array.from({ length: 3 }).map(() => `
                <div class="recent-report-item flex justify-between items-center py-3">
                    <div class="flex-1 pr-4 space-y-2">
                        <span class="absd-skeleton absd-skeleton-line" style="height: 1rem;"></span>
                        <span class="absd-skeleton absd-skeleton-line absd-skeleton-chip" style="width: 60%;"></span>
                    </div>
                    <div class="w-32 text-right space-y-2">
                        <span class="absd-skeleton absd-skeleton-line" style="height: 1rem;"></span>
                        <span class="absd-skeleton absd-skeleton-line absd-skeleton-chip" style="width: 70%;"></span>
                    </div>
                </div>
            `).join('');
        }

        function handleOutsideLayoutClick(event) {
            const panel = document.getElementById('layoutSettingsPanel');
            const toggle = document.getElementById('layoutSettingsToggle');
            if (!panel || !toggle || panel.classList.contains('hidden')) {
                return;
            }

            if (!panel.contains(event.target) && !toggle.contains(event.target)) {
                hideLayoutPanel();
            }
        }

        function enhanceFormControls(root = document) {
            const INPUT_SELECTOR = 'input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="tel"], input[type="url"], input[type="search"], input:not([type])';
            const legacyClasses = ['px-3', 'py-2', 'border', 'border-gray-300', 'border-gray-200', 'rounded', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring', 'focus:ring-blue-500'];

            root.querySelectorAll(INPUT_SELECTOR).forEach((input) => {
                if (!input.classList.contains('absd-input') && !input.classList.contains('absd-input--skip')) {
                    input.classList.add('absd-input');
                }
                legacyClasses.forEach(cls => input.classList.remove(cls));
            });

            root.querySelectorAll('select').forEach((select) => {
                if (!select.classList.contains('absd-select') && !select.classList.contains('absd-input--skip')) {
                    select.classList.add('absd-select');
                }
                legacyClasses.forEach(cls => select.classList.remove(cls));
            });

            root.querySelectorAll('textarea').forEach((textarea) => {
                if (!textarea.classList.contains('absd-textarea') && !textarea.classList.contains('absd-input--skip')) {
                    textarea.classList.add('absd-textarea');
                }
                legacyClasses.forEach(cls => textarea.classList.remove(cls));
            });

            const labelLegacyClasses = ['block', 'text-sm', 'font-medium', 'text-gray-700', 'text-gray-600', 'mb-1'];
            root.querySelectorAll('label').forEach((label) => {
                if (!label.classList.contains('absd-label') && !label.classList.contains('absd-label--skip')) {
                    label.classList.add('absd-label');
                }
                labelLegacyClasses.forEach(cls => label.classList.remove(cls));
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-PY', {
                style: 'currency',
                currency: 'PYG',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function focusElementById(id) {
            const el = document.getElementById(id);
            if (!el) return;
            if (typeof el.focus === 'function') {
                try {
                    el.focus({ preventScroll: true });
                } catch (error) {
                    el.focus();
                }
            }
            if (typeof el.scrollIntoView === 'function') {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('es-PY', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).format(date);
        }

        function formatDateTime(value) {
            if (!value) {
                return 'N/A';
            }
            return new Date(value).toLocaleString('es-PY');
        }

        function formatMonthName(month) {
            const names = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return names[(month - 1 + 12) % 12] || `${month}`;
        }

        function formatReportStatus(status) {
            const map = {
                procesado: 'Procesado',
                pendiente: 'Pendiente',
                borrador: 'Borrador',
                recibido: 'Recibido'
            };
            return map[status] || status;
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const titleEl = document.getElementById('toastTitle');
            const messageEl = document.getElementById('toastMessage');

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            icon.textContent = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function showLoading(element, show = true) {
            const loading = element.querySelector('.loading');
            const text = element.querySelector('span');

            if (show) {
                if (loading) loading.classList.remove('hidden');
                if (text) text.style.opacity = '0.7';
            } else {
                if (loading) loading.classList.add('hidden');
                if (text) text.style.opacity = '1';
            }
        }

        // Authentication
        async function login(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            showLoading(submitBtn);

            try {
                const response = await axios.post(`${API_BASE}/auth?action=login`, {
                    email,
                    password
                });

                authToken = response.data.token;
                currentUser = response.data.user;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showMainApp();
                showToast('¡Bienvenido!', 'Sesión iniciada correctamente', 'success');

            } catch (error) {
                showToast('Error', error.response?.data?.error || 'Error al iniciar sesión', 'error');
            } finally {
                showLoading(submitBtn, false);
            }
        }

        // Google OAuth Login Handler
        async function handleGoogleLogin(response) {
            console.log('Google login response:', response);

            try {
                const result = await axios.post(`${API_BASE}/auth?action=google`, {
                    credential: response.credential
                });

                console.log('Backend response:', result.data);

                authToken = result.data.token;
                currentUser = result.data.user;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                showMainApp();
                showToast(
                    '¡Bienvenido!',
                    `Sesión iniciada con Google como ${currentUser.name || currentUser.email}`,
                    'success'
                );

            } catch (error) {
                console.error('Google login error:', error);
                const errorMessage = error.response?.data?.error || 'Error al iniciar sesión con Google';
                showToast('Error de Autenticación', errorMessage, 'error');
            }
        }

        async function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            showLoginScreen();
            showToast('Sesión cerrada', 'Has cerrado sesión correctamente', 'info');
        }

        async function verifyAuth() {
            if (!authToken) return false;

            try {
                const response = await axios.get(`${API_BASE}/auth?action=verify`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                currentUser = response.data.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                return true;
            } catch (error) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                authToken = null;
                currentUser = null;
                return false;
            }
        }

        function showInitForm() {
            document.getElementById('initForm').classList.toggle('hidden');
        }

        async function initSystem() {
            const email = document.getElementById('initEmail').value;
            const password = document.getElementById('initPassword').value;

            if (!email || !password) {
                showToast('Error', 'Email y contraseña requeridos', 'error');
                return;
            }

            try {
                await axios.post(`${API_BASE}/auth?action=init`, { email, password });
                showToast('Sistema Inicializado', 'Ya puedes iniciar sesión', 'success');
                document.getElementById('initForm').classList.add('hidden');
                document.getElementById('loginEmail').value = email;
            } catch (error) {
                showToast('Error', error.response?.data?.error || 'Error al inicializar', 'error');
            }
        }

        // UI Navigation
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
            hideLayoutPanel();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            const userEmailEl = document.getElementById('userEmail');
            if (userEmailEl) {
                userEmailEl.textContent = currentUser?.email || '';
            }
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
            }

            applyLayoutPreferences({}, { save: false });
            showTab(currentTab);
        }

        function showTab(tabName) {
            currentTab = tabName;
            if (AVAILABLE_TABS.includes(tabName)) {
                localStorage.setItem(TAB_PREF_KEY, tabName);
            }

            document.querySelectorAll('.tab-content').forEach(tab => {
                const isActive = tab.id === `${tabName}Tab`;
                tab.classList.toggle('hidden', !isActive);
                tab.setAttribute('aria-hidden', (!isActive).toString());
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                const isActive = btn.dataset.tab === tabName;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });

            const tabSelect = document.getElementById('tabSelect');
            if (tabSelect && tabSelect.value !== tabName) {
                tabSelect.value = tabName;
            }

            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'monthly-ledger':
                    loadMonthlyLedgerTab();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'funds':
                    loadFunds();
                    break;
                case 'churches':
                    loadChurches();
                    break;
            }
        }

        function registerContextShortcuts() {
            if (!ABSD?.a11y?.registerShortcut) return;

            ABSD.a11y.registerShortcut('Alt+T', () => {
                showTab('transactions');
                setTimeout(() => focusElementById('filterTransactionFund'), 120);
            }, 'Ir a Transacciones');

            ABSD.a11y.registerShortcut('Alt+F', () => {
                showTab('funds');
                setTimeout(() => focusElementById('movementsFundFilter'), 120);
            }, 'Ir a Fondos');

            ABSD.a11y.registerShortcut('Alt+Shift+N', () => {
                showTab('transactions');
                setTimeout(() => openTransactionModal(), 120);
            }, 'Nueva transacción');

            ABSD.a11y.registerShortcut('Alt+Shift+F', () => {
                showTab('funds');
                setTimeout(() => openNewFundModal(), 120);
            }, 'Nuevo fondo');
        }

        // Dashboard - Now with ABSD Progressive Loading
        async function loadDashboard() {
            // Show skeleton states for metrics
            const metricElements = document.querySelectorAll('[data-skeleton-type="metric"]');
            metricElements.forEach(el => {
                ABSD.pipeline.showSkeleton(el);
            });

            // Show skeleton for recent reports
            const recentReportsEl = document.getElementById('recentReports');
            ABSD.pipeline.showSkeleton(recentReportsEl);

            const recentReportsStatus = document.getElementById('recentReportsStatus');

            try {
                // Use ABSD pipeline for progressive loading with offline support
                const data = await ABSD.pipeline.fetch(`${API_BASE}/dashboard`, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    container: null, // Manual skeleton handling
                    forceRefresh: false
                });

                // Restore original metric markup before updating
                metricElements.forEach(el => ABSD.pipeline.hideSkeleton(el));

                // Progressive metric updates with animation
                const updateMetric = (elementId, value, formatter = (v) => v) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        // Hide skeleton for parent container
                        ABSD.pipeline.hideSkeleton(element.closest('[data-skeleton-type]'));
                        // Update value with animation
                        element.style.opacity = '0';
                        setTimeout(() => {
                            element.textContent = formatter(value ?? 0);
                            element.style.opacity = '1';
                            element.style.transition = 'opacity 0.3s var(--ease-gentle)';
                        }, 100);
                    }
                };

                // Update metrics progressively
                updateMetric('totalChurches', data.totalChurches);
                updateMetric('reportedChurches', data.reportedChurches);
                updateMetric('monthTotal', data.monthTotal, formatCurrency);
                updateMetric('nationalFund', data.nationalFund, formatCurrency);

                // Hide skeleton for reports
                ABSD.pipeline.hideSkeleton(recentReportsEl);

                // Render recent reports with virtualization for large datasets
                if (recentReportsEl) {
                    if (Array.isArray(data.recentReports) && data.recentReports.length > 0) {
                        // Use virtualization if more than 50 reports
                        if (data.recentReports.length > 50) {
                            const virtualScroller = new ABSD.VirtualScroller(recentReportsEl, {
                                itemHeight: 80,
                                renderItem: (report) => {
                                    const church = escapeHtml(report.churchName || report.church || 'Iglesia sin nombre');
                                    const city = escapeHtml(report.city || 'Ciudad no registrada');
                                    const total = formatCurrency(report.totalEntradas ?? report.total_entradas ?? 0);
                                    const created = formatDate(report.createdAt || report.created_at);
                                    return `
                                        <article class="recent-report-item flex justify-between items-center gap-4 pb-3 px-2" role="listitem">
                                            <div>
                                                <p class="font-semibold text-gray-800">${church}</p>
                                                <p class="text-sm text-gray-500">${city}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-semibold text-gray-900">${total}</p>
                                                <p class="text-sm text-gray-500">${created}</p>
                                            </div>
                                        </article>
                                    `;
                                }
                            });
                            virtualScroller.setItems(data.recentReports);
                        } else {
                            // Regular rendering for small datasets
                            recentReportsEl.innerHTML = data.recentReports.map(report => {
                                const church = escapeHtml(report.churchName || report.church || 'Iglesia sin nombre');
                                const city = escapeHtml(report.city || 'Ciudad no registrada');
                                const total = formatCurrency(report.totalEntradas ?? report.total_entradas ?? 0);
                                const created = formatDate(report.createdAt || report.created_at);
                                return `
                                    <article class="recent-report-item flex justify-between items-center gap-4 pb-3" role="listitem">
                                        <div>
                                            <p class="font-semibold text-gray-800">${church}</p>
                                            <p class="text-sm text-gray-500">${city}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-gray-900">${total}</p>
                                            <p class="text-sm text-gray-500">${created}</p>
                                        </div>
                                    </article>
                                `;
                            }).join('');
                        }
                    } else {
                        recentReportsEl.innerHTML = '<div class="absd-data-empty">No hay informes recientes</div>';
                    }
                }

                // Update status with ABSD state management
                if (recentReportsStatus) {
                    const count = Array.isArray(data.recentReports) ? data.recentReports.length : 0;
                    const timestamp = new Date().toLocaleTimeString('es-PY');
                    recentReportsStatus.textContent = `Actualizado ${timestamp} · ${count} informe(s)`;

                    // Save to state manager for persistence
                    ABSD.state.set('dashboard.lastUpdate', timestamp);
                    ABSD.state.set('dashboard.reportCount', count);
                }

                // Log successful load
                ABSD.Core.logAction('dashboard_loaded', {
                    reportCount: data.recentReports?.length || 0,
                    timestamp: new Date().toISOString()
                });

            } catch (error) {
                console.error('Error al cargar dashboard', error);

                // Hide all skeletons
                metricElements.forEach(el => {
                    ABSD.pipeline.hideSkeleton(el);
                });
                ABSD.pipeline.hideSkeleton(recentReportsEl);

                // Show error states using ABSD patterns
                if (recentReportsEl) {
                    recentReportsEl.innerHTML = `
                        <div class="absd-data-error">
                            <h3 class="text-lg font-semibold mb-2">¿Qué pasó?</h3>
                            <p class="mb-4">No se pudieron cargar los informes recientes</p>
                            <h4 class="font-semibold mb-2">Cómo resolver:</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Verifique su conexión a Internet</li>
                                <li>Intente recargar la página</li>
                                <li>Si el problema persiste, contacte al soporte</li>
                            </ul>
                        </div>
                    `;
                }

                if (recentReportsStatus) {
                    recentReportsStatus.textContent = 'Error al cargar';
                }

                showToast('Error', 'Error al cargar dashboard', 'error');
            }
        }

        // Reports
        async function loadReports() {
            try {
                const response = await axios.get(`${API_BASE}/reports`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const reports = response.data;
                const reportsListEl = document.getElementById('reportsList');

                if (reports.length > 0) {
                    reportsListEl.innerHTML = reports.map(report => {
                        const submittedAt = report.submitted_at || report.created_at;
                        const statusClasses = report.estado === 'procesado'
                            ? 'bg-green-100 text-green-800'
                            : report.estado === 'borrador'
                                ? 'bg-gray-100 text-gray-700'
                                : 'bg-yellow-100 text-yellow-800';
                        return `
                        <div class="border rounded-lg p-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                <div>
                                    <h4 class="font-semibold">${report.church_name}</h4>
                                    <p class="text-sm text-gray-600">${report.city} - ${report.pastor}</p>
                                    <p class="text-sm text-gray-500">${formatMonthName(report.month)} ${report.year}</p>
                                    <p class="text-xs text-gray-400">${submittedAt ? `Enviado ${formatDateTime(submittedAt)}` : 'Fecha no disponible'}</p>
                                </div>
                                <div class="text-right space-y-2">
                                    <div class="font-semibold text-lg">${formatCurrency(report.total_entradas)}</div>
                                    <div class="text-sm text-gray-500">Fondo Nacional: ${formatCurrency(report.fondo_nacional)}</div>
                                    <div class="flex items-center gap-2 justify-end">
                                        <span class="inline-block px-2 py-1 text-xs rounded-full ${statusClasses}">${formatReportStatus(report.estado)}</span>
                                        ${report.estado !== 'procesado' ? `<button type="button" class="text-xs text-blue-600 hover:text-blue-800" onclick="markReportProcessed(${report.id})">Procesar</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    reportsListEl.innerHTML = '<p class="text-gray-500 text-center py-8">No hay informes disponibles</p>';
                }

            } catch (error) {
                showToast('Error', 'Error al cargar informes', 'error');
            }
        }

        async function filterReports() {
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;

            let url = `${API_BASE}/reports`;
            const params = new URLSearchParams();

            if (year) params.append('year', year);
            if (month) params.append('month', month);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            try {
                const response = await axios.get(url, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const reports = response.data;
                const reportsListEl = document.getElementById('reportsList');

                if (reports.length > 0) {
                    reportsListEl.innerHTML = reports.map(report => {
                        const submittedAt = report.submitted_at || report.created_at;
                        const statusClasses = report.estado === 'procesado'
                            ? 'bg-green-100 text-green-800'
                            : report.estado === 'borrador'
                                ? 'bg-gray-100 text-gray-700'
                                : 'bg-yellow-100 text-yellow-800';
                        return `
                        <div class="border rounded-lg p-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                <div>
                                    <h4 class="font-semibold">${report.church_name}</h4>
                                    <p class="text-sm text-gray-600">${report.city} - ${report.pastor}</p>
                                    <p class="text-sm text-gray-500">${formatMonthName(report.month)} ${report.year}</p>
                                    <p class="text-xs text-gray-400">${submittedAt ? `Enviado ${formatDateTime(submittedAt)}` : 'Fecha no disponible'}</p>
                                </div>
                                <div class="text-right space-y-2">
                                    <div class="font-semibold text-lg">${formatCurrency(report.total_entradas)}</div>
                                    <div class="text-sm text-gray-500">Fondo Nacional: ${formatCurrency(report.fondo_nacional)}</div>
                                    <div class="flex items-center gap-2 justify-end">
                                        <span class="inline-block px-2 py-1 text-xs rounded-full ${statusClasses}">${formatReportStatus(report.estado)}</span>
                                        ${report.estado !== 'procesado' ? `<button type="button" class="text-xs text-blue-600 hover:text-blue-800" onclick="markReportProcessed(${report.id})">Procesar</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    reportsListEl.innerHTML = '<p class="text-gray-500 text-center py-8">No se encontraron informes con los filtros aplicados</p>';
                }

            } catch (error) {
                showToast('Error', 'Error al filtrar informes', 'error');
            }
        }

        async function markReportProcessed(reportId) {
            try {
                await axios.put(`${API_BASE}/reports?id=${reportId}`, {
                    estado: 'procesado'
                }, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Informe marcado como procesado', 'success');
                loadReports();
                loadDashboard();
            } catch (error) {
                showToast('Error', error.response?.data?.error || 'No se pudo actualizar el informe', 'error');
            }
        }

        // Churches
        async function loadChurches() {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const churches = response.data;
                const churchesListEl = document.getElementById('churchesList');

                if (churches.length > 0) {
                    churchesListEl.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full" role="table" aria-label="Listado de iglesias">
                                <caption class="absd-sr-only">Iglesias registradas con su ciudad, pastor responsable y estado</caption>
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Iglesia</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Ciudad</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Pastor</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Grado</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Estado</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${churches.map(church => `
                                        <tr>
                                            <td class="px-4 py-3 font-medium">${escapeHtml(church.name || '')}</td>
                                            <td class="px-4 py-3">${escapeHtml(church.city || '')}</td>
                                            <td class="px-4 py-3">${escapeHtml(church.pastor || '')}</td>
                                            <td class="px-4 py-3">${escapeHtml(church.pastor_grado || '-')}</td>
                                            <td class="px-4 py-3">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                                    church.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                }">
                                                    ${church.active ? 'Activa' : 'Inactiva'}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex space-x-2">
                                                    <button onclick="editChurch(${church.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                                                        Editar
                                                    </button>
                                                    <button onclick="toggleChurchStatus(${church.id})" class="text-gray-600 hover:text-gray-800 text-sm">
                                                        ${church.active ? 'Desactivar' : 'Activar'}
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    churchesListEl.innerHTML = '<p class="text-gray-500 text-center py-8">No hay iglesias registradas</p>';
                }

            } catch (error) {
                showToast('Error', 'Error al cargar iglesias', 'error');
            }
        }

        // Export
        async function exportData(type) {
            let url = `${API_BASE}/data?action=export&type=${type}`;

            if (type === 'monthly') {
                const year = document.getElementById('exportYear').value;
                const month = document.getElementById('exportMonth').value;
                url += `&year=${year}&month=${month}`;
            } else if (type === 'yearly') {
                const year = document.getElementById('exportYearlyYear').value;
                url += `&year=${year}`;
            } else if (type === 'churches') {
                url += `&year=${new Date().getFullYear()}`;
            }

            try {
                const response = await axios.get(url, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    responseType: 'blob'
                });

                // Create download link
                const blob = new Blob([response.data]);
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;

                // Get filename from response headers or generate one
                const contentDisposition = response.headers['content-disposition'];
                let filename = 'export.xlsx';

                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                link.download = filename;
                link.click();

                window.URL.revokeObjectURL(downloadUrl);
                showToast('Exportación Exitosa', 'Archivo descargado correctamente', 'success');

            } catch (error) {
                showToast('Error', error.response?.data?.error || 'Error al exportar datos', 'error');
            }
        }

        // Initialize app
        async function init() {
            axios.defaults.headers.common['Content-Type'] = 'application/json';

            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', login);
            }

            const themeSelect = document.getElementById('themePreference');
            const densitySelect = document.getElementById('densityPreference');
            const layoutToggle = document.getElementById('layoutSettingsToggle');
            const layoutApply = document.getElementById('layoutSettingsApply');
            const layoutClose = document.getElementById('layoutSettingsClose');

            if (layoutToggle) {
                layoutToggle.addEventListener('click', (event) => {
                    event.preventDefault();
                    toggleLayoutPanel();
                });
            }

            if (layoutApply) {
                layoutApply.addEventListener('click', () => {
                    applyLayoutPreferences({
                        theme: themeSelect?.value || layoutPrefs.theme,
                        density: densitySelect?.value || layoutPrefs.density
                    }, { save: true, closePanel: true });
                });
            }

            if (layoutClose) {
                layoutClose.addEventListener('click', hideLayoutPanel);
            }

            if (themeSelect) {
                themeSelect.addEventListener('change', (event) => {
                    applyLayoutPreferences({ theme: event.target.value }, { save: true });
                });
            }

            if (densitySelect) {
                densitySelect.addEventListener('change', (event) => {
                    applyLayoutPreferences({ density: event.target.value }, { save: true });
                });
            }

            document.addEventListener('click', handleOutsideLayoutClick);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && isLayoutPanelOpen()) {
                    hideLayoutPanel();
                }
            });

            const tabSelect = document.getElementById('tabSelect');
            if (tabSelect) {
                tabSelect.value = currentTab;
                tabSelect.addEventListener('change', handleTabSelectChange);
            }

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('keydown', handleTabKeyDown);
            });

            const handleSystemThemeChange = () => {
                if (layoutPrefs.theme === 'auto') {
                    applyLayoutPreferences({}, { save: false });
                }
            };

            if (typeof themeMediaQuery.addEventListener === 'function') {
                themeMediaQuery.addEventListener('change', handleSystemThemeChange);
            } else if (typeof themeMediaQuery.addListener === 'function') {
                themeMediaQuery.addListener(handleSystemThemeChange);
            }

            applyLayoutPreferences({}, { save: false });
            enhanceFormControls();

            if (authToken) {
                const isValid = await verifyAuth();
                if (isValid) {
                    showMainApp();
                } else {
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;


            const exportMonthEl = document.getElementById('exportMonth');
            if (exportMonthEl) exportMonthEl.value = currentMonth;

            const filterYearEl = document.getElementById('filterYear');
            if (filterYearEl) {
                filterYearEl.innerHTML = `
                <option value="">Todos los años</option>
                <option value="${currentYear}">${currentYear}</option>
                <option value="${currentYear - 1}">${currentYear - 1}</option>
            `;
            }
        }

        // Manual Report Functions
        async function openManualReportModal() {
            // Load churches into dropdown
            await loadChurchesForManualEntry();

            // Reset form
            document.getElementById('manualReportForm').reset();

            // Set current year
            const currentYear = new Date().getFullYear();
            document.getElementById('manualYear').value = currentYear;

            // Show modal
            document.getElementById('manualReportModal').classList.remove('hidden');
        }

        function closeManualReportModal() {
            document.getElementById('manualReportModal').classList.add('hidden');
        }

        async function loadChurchesForManualEntry() {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const churchSelect = document.getElementById('manualChurchId');
                churchSelect.innerHTML = '<option value="">Seleccionar iglesia...</option>';

                response.data.forEach(church => {
                    const option = document.createElement('option');
                    option.value = church.id;
                    option.textContent = `${church.name} - ${church.city}`;
                    churchSelect.appendChild(option);
                });
            } catch (error) {
                showToast('Error', 'Error al cargar iglesias', 'error');
            }
        }

        // Handle manual report form submission
        document.getElementById('manualReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                church_id: document.getElementById('manualChurchId').value,
                year: parseInt(document.getElementById('manualYear').value),
                month: parseInt(document.getElementById('manualMonth').value),
                submission_type: 'manual',
                submitted_by: 'admin', // Current user

                // Entradas del mes
                diezmos: parseFloat(document.getElementById('manualDiezmos').value) || 0,
                ofrendas: parseFloat(document.getElementById('manualOfrendas').value) || 0,
                anexos: parseFloat(document.getElementById('manualAnexos').value) || 0,
                caballeros: parseFloat(document.getElementById('manualCaballeros').value) || 0,
                damas: parseFloat(document.getElementById('manualDamas').value) || 0,
                jovenes: parseFloat(document.getElementById('manualJovenes').value) || 0,
                ninos: parseFloat(document.getElementById('manualNinos').value) || 0,
                otros: parseFloat(document.getElementById('manualOtros').value) || 0,

                // Ofrendas directas - fondo nacional
                ofrendas_directas_misiones: parseFloat(document.getElementById('manualOfrendaDirectasMisiones').value) || 0,
                lazos_amor: parseFloat(document.getElementById('manualLazosAmor').value) || 0,
                mision_posible: parseFloat(document.getElementById('manualMisionPosible').value) || 0,
                aporte_caballeros: parseFloat(document.getElementById('manualAporteCaballeros').value) || 0,
                apy: parseFloat(document.getElementById('manualApy').value) || 0,
                instituto_biblico: parseFloat(document.getElementById('manualInstitutoBiblico').value) || 0,
                diezmo_pastoral: parseFloat(document.getElementById('manualDiezmoPastoral').value) || 0,

                // Información de depósito
                fecha_deposito: document.getElementById('manualFechaDeposito').value || null,
                numero_deposito: document.getElementById('manualNumeroDeposito').value || '',
                monto_depositado: parseFloat(document.getElementById('manualMontoDepositado').value) || 0,

                // Asistencias y bautismos
                asistencia_visitas: parseInt(document.getElementById('manualAsistenciaVisitas').value) || 0,
                bautismos_agua: parseInt(document.getElementById('manualBautismosAgua').value) || 0,
                bautismos_espiritu: parseInt(document.getElementById('manualBautismosEspiritu').value) || 0,

                // Observaciones
                observaciones: document.getElementById('manualObservaciones').value || ''
            };

            try {
                const response = await axios.post(`${API_BASE}/reports`, formData, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Informe registrado correctamente', 'success');
                closeManualReportModal();

                // Refresh reports list if we're on the reports tab
                if (currentTab === 'reports') {
                    loadReports();
                }

                // Refresh dashboard
                loadDashboard();

            } catch (error) {
                console.error('Error saving manual report:', error);
                showToast('Error', error.response?.data?.error || 'Error al guardar el informe', 'error');
            }
        });

                // Transaction Functions
        let transactionEntries = [];
        let transactionsScroller = null;
        let fundsScroller = null;
        let fundMovementsScroller = null;

        async function openTransactionModal() {
            await loadFundsForTransaction();
            await loadChurchesForTransaction();
            resetTransactionEntryForm();
            transactionEntries = [];
            renderTransactionEntries();

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;

            document.getElementById('transactionModal').classList.remove('hidden');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
        }

        function resetTransactionEntryForm() {
            document.getElementById('transactionConcept').value = '';
            document.getElementById('transactionProvider').value = '';
            document.getElementById('transactionDocument').value = '';
            document.getElementById('transactionAmountIn').value = '';
            document.getElementById('transactionAmountOut').value = '';
        }

        async function loadFundsForTransaction() {
            try {
                const response = await axios.get(`${API_BASE}/financial?type=funds`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const fundSelects = [
                    document.getElementById('transactionFund'),
                    document.getElementById('filterTransactionFund')
                ];

                fundSelects.forEach(select => {
                    if (!select) return;
                    const placeholder = select.id === 'transactionFund' ? 'Seleccionar fondo...' : 'Todos los fondos';
                    select.innerHTML = `<option value="">${placeholder}</option>`;

                    (response.data.data || response.data).forEach(fund => {
                        const option = document.createElement('option');
                        option.value = fund.id;
                        option.textContent = `${fund.name}`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                showToast('Error', 'Error al cargar fondos', 'error');
            }
        }

        async function loadChurchesForTransaction() {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const churchSelects = [
                    document.getElementById('transactionChurch'),
                    document.getElementById('filterTransactionChurch')
                ];

                churchSelects.forEach(select => {
                    if (!select) return;
                    const placeholder = select.id === 'transactionChurch' ? 'Seleccionar iglesia...' : 'Todas las iglesias';
                    select.innerHTML = `<option value="">${placeholder}</option>`;

                    response.data.forEach(church => {
                        const option = document.createElement('option');
                        option.value = church.id;
                        option.textContent = `${church.name} - ${church.city}`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                showToast('Error', 'Error al cargar iglesias', 'error');
            }
        }

        function addTransactionEntry() {
            const date = document.getElementById('transactionDate').value;
            const fundSelect = document.getElementById('transactionFund');
            const fundId = fundSelect.value;
            const fundName = fundSelect.options[fundSelect.selectedIndex]?.text || '';
            const churchId = document.getElementById('transactionChurch').value || null;
            const concept = document.getElementById('transactionConcept').value.trim();
            const provider = document.getElementById('transactionProvider').value.trim();
            const documentNumber = document.getElementById('transactionDocument').value.trim();
            const amountIn = parseFloat(document.getElementById('transactionAmountIn').value) || 0;
            const amountOut = parseFloat(document.getElementById('transactionAmountOut').value) || 0;

            if (!date || !fundId || !concept) {
                showToast('Error', 'Completa fecha, fondo y concepto antes de agregar.', 'error');
                return;
            }

            if ((amountIn === 0 && amountOut === 0) || (amountIn > 0 && amountOut > 0)) {
                showToast('Error', 'Indica solo un monto de entrada o de salida.', 'error');
                return;
            }

            transactionEntries.push({
                date,
                fund_id: fundId,
                fund_name: fundName,
                church_id: churchId,
                concept,
                provider,
                document_number: documentNumber,
                amount_in: amountIn,
                amount_out: amountOut
            });

            renderTransactionEntries();
            resetTransactionEntryForm();
        }

        function renderTransactionEntries() {
            const container = document.getElementById('transactionEntriesContainer');
            const tableBody = document.getElementById('transactionEntriesTable');
            if (!container || !tableBody) return;

            if (transactionEntries.length === 0) {
                container.classList.add('hidden');
                tableBody.innerHTML = '';
                return;
            }

            container.classList.remove('hidden');
            tableBody.innerHTML = transactionEntries.map((entry, index) => `
                <tr>
                    <td class="px-4 py-2">${formatDate(entry.date)}</td>
                    <td class="px-4 py-2">${entry.fund_name}</td>
                    <td class="px-4 py-2">${entry.concept}</td>
                    <td class="px-4 py-2 text-right">${entry.amount_in > 0 ? formatCurrency(entry.amount_in) : '-'}</td>
                    <td class="px-4 py-2 text-right">${entry.amount_out > 0 ? formatCurrency(entry.amount_out) : '-'}</td>
                    <td class="px-4 py-2 text-center">
                        <button type="button" class="text-red-600 hover:text-red-800 text-xs" onclick="removeTransactionEntry(${index})">Quitar</button>
                    </td>
                </tr>
            `).join('');
        }

        function removeTransactionEntry(index) {
            transactionEntries.splice(index, 1);
            renderTransactionEntries();
        }

        async function submitTransactionBatch() {
            if (!transactionEntries.length) {
                showToast('Error', 'Agrega al menos una partida antes de registrar.', 'error');
                return;
            }

            const payload = {
                entries: transactionEntries.map(entry => ({
                    date: entry.date,
                    fund_id: entry.fund_id,
                    church_id: entry.church_id,
                    concept: entry.concept,
                    provider: entry.provider,
                    document_number: entry.document_number,
                    amount_in: entry.amount_in,
                    amount_out: entry.amount_out
                }))
            };

            try {
                await axios.post(`${API_BASE}/financial?type=transactions`, payload, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Transacciones registradas correctamente', 'success');
                closeTransactionModal();
                loadTransactions();
                loadFunds();
            } catch (error) {
                console.error('Error saving transactions:', error);
                showToast('Error', error.response?.data?.error || 'Error al guardar las transacciones', 'error');
            }
        }

        function filterTransactions() {
            loadTransactions();
        }

        async function loadTransactions() {
            const container = document.getElementById('transactionsListContainer');
            const listEl = document.getElementById('transactionsVirtualList');
            if (container) {
                ABSD.pipeline.showSkeleton(container);
            }

            try {
                const params = new URLSearchParams();

                const filterFund = document.getElementById('filterTransactionFund')?.value;
                const filterChurch = document.getElementById('filterTransactionChurch')?.value;
                const filterDateFrom = document.getElementById('filterTransactionDateFrom')?.value;

                if (filterFund) params.append('fund_id', filterFund);
                if (filterChurch) params.append('church_id', filterChurch);
                if (filterDateFrom) params.append('date_from', filterDateFrom);

                const url = `${API_BASE}/financial?type=transactions` + (params.toString() ? `&${params}` : '');
                const data = await ABSD.pipeline.fetch(url, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    container: null,
                    forceRefresh: true
                });

                const rows = Array.isArray(data) ? data : (data?.data || []);

                if (!listEl) {
                    if (container) {
                        ABSD.pipeline.hideSkeleton(container);
                    }
                    return;
                }

                const renderItem = (transaction) => {
                    const date = escapeHtml(formatDate(transaction.date));
                    const church = escapeHtml(transaction.church_name || '-');
                    const fundLabel = escapeHtml(transaction.fund_name || '-');
                    const concept = escapeHtml(transaction.concept || '-');
                    const provider = escapeHtml(transaction.provider || '-');
                    const documentNumber = escapeHtml(transaction.document_number || '-');
                    const amountIn = transaction.amount_in > 0 ? formatCurrency(transaction.amount_in) : '-';
                    const amountOut = transaction.amount_out > 0 ? formatCurrency(transaction.amount_out) : '-';
                    const balance = formatCurrency(transaction.balance || 0);
                    const fundTypeClass = transaction.fund_type === 'national' ? 'absd-pill absd-pill--info' : 'absd-pill absd-pill--success';
                    const amountInClass = transaction.amount_in > 0 ? ' absd-cell--positive' : '';
                    const amountOutClass = transaction.amount_out > 0 ? ' absd-cell--negative' : '';

                    return `
                        <article class="absd-virtual-row absd-virtual-row--transactions" role="row">
                            <span role="cell" class="absd-cell">${date}</span>
                            <span role="cell" class="absd-cell">${church}</span>
                            <span role="cell" class="absd-cell"><span class="${fundTypeClass}">${fundLabel}</span></span>
                            <span role="cell" class="absd-cell absd-cell--truncate" title="${concept}">${concept}</span>
                            <span role="cell" class="absd-cell">${provider}</span>
                            <span role="cell" class="absd-cell">${documentNumber}</span>
                            <span role="cell" class="absd-cell absd-cell--numeric${amountInClass}">${amountIn}</span>
                            <span role="cell" class="absd-cell absd-cell--numeric${amountOutClass}">${amountOut}</span>
                            <span role="cell" class="absd-cell absd-cell--numeric absd-cell--emphasis">${balance}</span>
                            <span role="cell" class="absd-cell absd-cell--actions">
                                <button type="button" class="absd-link-button" onclick="editTransaction(${transaction.id})">Editar</button>
                                <button type="button" class="absd-link-button absd-link-button--danger" onclick="deleteTransaction(${transaction.id})">Eliminar</button>
                            </span>
                        </article>
                    `;
                };

                if (!rows.length) {
                    if (transactionsScroller) {
                        transactionsScroller.destroy();
                        transactionsScroller = null;
                    }
                    listEl.innerHTML = '<div class="absd-data-empty">No se encontraron transacciones con los filtros aplicados</div>';
                } else {
                    if (!transactionsScroller) {
                        listEl.innerHTML = '';
                        transactionsScroller = new ABSD.VirtualScroller(listEl, {
                            itemHeight: 96,
                            threshold: 80,
                            renderItem
                        });
                    } else {
                        transactionsScroller.options.renderItem = renderItem;
                    }
                    transactionsScroller.setItems(rows);
                }
            } catch (error) {
                console.error('Error al filtrar transacciones', error);
                showToast('Error', 'Error al filtrar transacciones', 'error');
                const listEl = document.getElementById('transactionsVirtualList');
                if (listEl) {
                    listEl.innerHTML = '<div class="absd-data-error">No se pudieron cargar las transacciones</div>';
                }
            } finally {
                if (container) {
                    ABSD.pipeline.hideSkeleton(container);
                }
            }
        }

        async function editTransaction(id) {
            const newConcept = prompt('Nuevo concepto:');
            if (newConcept && newConcept.trim()) {
                try {
                    await axios.put(`${API_BASE}/financial?type=transactions&id=${id}`, {
                        concept: newConcept.trim()
                    }, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });

                    showToast('Éxito', 'Transacción actualizada', 'success');
                    loadTransactions();
                } catch (error) {
                    showToast('Error', error.response?.data?.error || 'Error al actualizar transacción', 'error');
                }
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('¿Está seguro de que desea eliminar esta transacción? Esta acción no se puede deshacer.')) {
                return;
            }
            try {
                await axios.delete(`${API_BASE}/financial?type=transactions&id=${id}`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Transacción eliminada', 'success');
                loadTransactions();
            } catch (error) {
                showToast('Error', error.response?.data?.error || 'Error al eliminar transacción', 'error');
            }
        }

        document.getElementById('transactionForm').addEventListener('submit', (event) => {
            event.preventDefault();
            addTransactionEntry();
        });
        document.getElementById('addTransactionEntryBtn').addEventListener('click', addTransactionEntry);
        document.getElementById('saveTransactionBatchBtn').addEventListener('click', submitTransactionBatch);

        // Fund Management Functions
        async function loadFunds() {
            const container = document.getElementById('fundsListContainer');
            if (container) {
                ABSD.pipeline.showSkeleton(container);
            }

            try {
                const data = await ABSD.pipeline.fetch(`${API_BASE}/financial?type=funds`, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    container: null,
                    forceRefresh: true
                });

                const funds = data?.data || data || [];
                updateFundDashboard(funds);
                populateFundTable(funds);
                populateFundFilters(funds);
                await filterFundMovements();

            } catch (error) {
                console.error('Error loading funds:', error);
                showToast('Error', 'Error al cargar fondos', 'error');
                const listEl = document.getElementById('fundsVirtualList');
                if (listEl) {
                    listEl.innerHTML = '<div class="absd-data-error">No se pudieron cargar los fondos.</div>';
                }
            } finally {
                if (container) {
                    ABSD.pipeline.hideSkeleton(container);
                }
            }
        }

        function updateFundDashboard(funds) {
            const totalFunds = funds.length;
            const totalBalance = funds.reduce((sum, fund) => sum + (parseFloat(fund.current_balance) || 0), 0);
            const activeFunds = funds.filter(fund => fund.is_active).length;

            document.getElementById('totalFunds').textContent = totalFunds;
            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('activeFunds').textContent = activeFunds;

            // TODO: Add today's movements count
            document.getElementById('todayMovements').textContent = '0';
        }

        function populateFundTable(funds) {
            const container = document.getElementById('fundsListContainer');
            const listEl = document.getElementById('fundsVirtualList');
            if (!listEl) return;

            const renderItem = (fund) => {
                const fundName = escapeHtml(fund.name || 'Fondo sin nombre');
                const fundType = escapeHtml(getFundTypeName(fund.type));
                const balance = formatCurrency(fund.current_balance || 0);
                const updated = formatDate(fund.updated_at);
                const statusLabel = fund.is_active ? 'Activo' : 'Inactivo';
                const statusClass = fund.is_active ? 'absd-pill absd-pill--success' : 'absd-pill absd-pill--neutral';

                return `
                    <article class="absd-virtual-row absd-virtual-row--funds" role="row">
                        <span role="cell" class="absd-cell">${fundName}</span>
                        <span role="cell" class="absd-cell"><span class="absd-pill absd-pill--info">${fundType}</span></span>
                        <span role="cell" class="absd-cell absd-cell--numeric absd-cell--emphasis">${balance}</span>
                        <span role="cell" class="absd-cell absd-cell--numeric">${updated}</span>
                        <span role="cell" class="absd-cell"><span class="${statusClass}">${statusLabel}</span></span>
                        <span role="cell" class="absd-cell absd-cell--actions">
                            <button type="button" class="absd-link-button" onclick="editFund(${fund.id})">Editar</button>
                            <button type="button" class="absd-link-button" onclick="toggleFundStatus(${fund.id})">${fund.is_active ? 'Desactivar' : 'Activar'}</button>
                        </span>
                    </article>
                `;
            };

            if (!funds.length) {
                if (fundsScroller) {
                    fundsScroller.destroy();
                    fundsScroller = null;
                }
                listEl.innerHTML = '<div class="absd-data-empty">No se encontraron fondos registrados.</div>';
                return;
            }

            if (!fundsScroller) {
                listEl.innerHTML = '';
                fundsScroller = new ABSD.VirtualScroller(listEl, {
                    itemHeight: 88,
                    threshold: 60,
                    renderItem
                });
            } else {
                fundsScroller.options.renderItem = renderItem;
            }

            fundsScroller.setItems(funds);
        }

        function populateFundFilters(funds) {
            const select = document.getElementById('movementsFundFilter');
            select.innerHTML = '<option value="">Todos los fondos</option>';

            funds.forEach(fund => {
                const option = document.createElement('option');
                option.value = fund.id;
                option.textContent = fund.name;
                select.appendChild(option);
            });
        }

        function getFundTypeColor(type) {
            const colors = {
                'national': 'blue',
                'restricted': 'green'
            };
            return colors[type] || 'gray';
        }

        function getFundTypeName(type) {
            const names = {
                'national': 'Nacional',
                'restricted': 'Restringido/Especial'
            };
            return names[type] || 'Desconocido';
        }

        function openNewFundModal() {
            document.getElementById('fundForm').reset();
            document.getElementById('fundModal').classList.remove('hidden');
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.add('hidden');
        }

        async function filterFundMovements() {
            const fundId = document.getElementById('movementsFundFilter').value;
            const dateFrom = document.getElementById('movementsDateFrom').value;
            const dateTo = document.getElementById('movementsDateTo').value;
            const container = document.getElementById('fundMovementsListContainer');

            if (container) {
                ABSD.pipeline.showSkeleton(container);
            }

            try {
                const params = new URLSearchParams();

                if (fundId) params.append('fund_id', fundId);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);

                const url = `${API_BASE}/fund-movements${params.toString() ? `?${params}` : ''}`;
                const data = await ABSD.pipeline.fetch(url, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    container: null,
                    forceRefresh: true
                });

                const movements = Array.isArray(data) ? data : (data?.data || []);
                populateFundMovementsTable(movements);

            } catch (error) {
                console.error('Error loading fund movements:', error);
                showToast('Error', 'Error al cargar movimientos', 'error');
                const listEl = document.getElementById('fundMovementsVirtualList');
                if (listEl) {
                    listEl.innerHTML = '<div class="absd-data-error">No se pudieron cargar los movimientos.</div>';
                }
            } finally {
                if (container) {
                    ABSD.pipeline.hideSkeleton(container);
                }
            }
        }

        function populateFundMovementsTable(movements) {
            const listEl = document.getElementById('fundMovementsVirtualList');
            if (!listEl) return;

            const renderItem = (movement) => {
                const date = escapeHtml(formatDate(movement.created_at));
                const fundName = escapeHtml(movement.fund_name || 'N/A');
                const concept = escapeHtml(movement.concept || 'N/A');
                const previous = formatCurrency(movement.previous_balance || 0);
                const movementAmount = parseFloat(movement.movement) || 0;
                const movementLabel = `${movementAmount >= 0 ? '+' : ''}${formatCurrency(Math.abs(movementAmount))}`;
                const newBalance = formatCurrency(movement.new_balance || 0);
                const movementClass = movementAmount >= 0 ? 'absd-cell--positive' : 'absd-cell--negative';

                return `
                    <article class="absd-virtual-row absd-virtual-row--fund-movements" role="row">
                        <span role="cell" class="absd-cell">${date}</span>
                        <span role="cell" class="absd-cell">${fundName}</span>
                        <span role="cell" class="absd-cell absd-cell--truncate" title="${concept}">${concept}</span>
                        <span role="cell" class="absd-cell absd-cell--numeric">${previous}</span>
                        <span role="cell" class="absd-cell absd-cell--numeric ${movementClass}">${movementLabel}</span>
                        <span role="cell" class="absd-cell absd-cell--numeric absd-cell--emphasis">${newBalance}</span>
                    </article>
                `;
            };

            if (!movements.length) {
                if (fundMovementsScroller) {
                    fundMovementsScroller.destroy();
                    fundMovementsScroller = null;
                }
                listEl.innerHTML = '<div class="absd-data-empty">No se registraron movimientos para los filtros seleccionados.</div>';
                return;
            }

            if (!fundMovementsScroller) {
                listEl.innerHTML = '';
                fundMovementsScroller = new ABSD.VirtualScroller(listEl, {
                    itemHeight: 88,
                    threshold: 80,
                    renderItem
                });
            } else {
                fundMovementsScroller.options.renderItem = renderItem;
            }

            fundMovementsScroller.setItems(movements);
        }

        // Handle fund form submission
        document.getElementById('fundForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('fundName').value,
                type: document.getElementById('fundType').value,
                description: document.getElementById('fundDescription').value,
                current_balance: parseFloat(document.getElementById('fundInitialBalance').value) || 0,
                is_active: document.getElementById('fundActive').checked
            };

            try {
                await axios.post(`${API_BASE}/financial?type=funds`, formData, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Fondo creado correctamente', 'success');
                closeFundModal();

                // Refresh fund list if we're on the funds tab
                if (currentTab === 'funds') {
                    loadFunds();
                }

            } catch (error) {
                console.error('Error creating fund:', error);
                showToast('Error', error.response?.data?.error || 'Error al crear el fondo', 'error');
            }
        });

        async function editFund(fundId) {
            // TODO: Implement fund editing
            showToast('Info', 'Función de edición en desarrollo', 'info');
        }

        async function toggleFundStatus(fundId) {
            try {
                await axios.put(`${API_BASE}/financial?type=funds&id=${fundId}`, {}, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Estado del fondo actualizado', 'success');
                loadFunds();

            } catch (error) {
                console.error('Error toggling fund status:', error);
                showToast('Error', 'Error al actualizar el estado del fondo', 'error');
            }
        }

        // Church Management Functions
        function openNewChurchModal() {
            document.getElementById('churchModalTitle').textContent = 'Nueva Iglesia';
            document.getElementById('churchForm').reset();
            document.getElementById('churchId').value = '';
            document.getElementById('churchModal').classList.remove('hidden');
        }

        function closeChurchModal() {
            document.getElementById('churchModal').classList.add('hidden');
        }

        function filterChurches() {
            const searchTerm = document.getElementById('churchSearch').value.toLowerCase();
            const statusFilter = document.getElementById('churchStatusFilter').value;

            const rows = document.querySelectorAll('#churchesList tr');
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const city = row.cells[1]?.textContent.toLowerCase() || '';
                const pastor = row.cells[2]?.textContent.toLowerCase() || '';
                const status = row.querySelector('.status-badge')?.textContent.toLowerCase() || '';

                const matchesSearch = name.includes(searchTerm) ||
                                    city.includes(searchTerm) ||
                                    pastor.includes(searchTerm);
                const matchesStatus = statusFilter === '' || status.includes(statusFilter);

                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            });
        }

        async function editChurch(churchId) {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const church = response.data.find(c => c.id === churchId);
                if (!church) {
                    showToast('Error', 'Iglesia no encontrada', 'error');
                    return;
                }

                document.getElementById('churchModalTitle').textContent = 'Editar Iglesia';
                document.getElementById('churchId').value = church.id;
                document.getElementById('churchName').value = church.name || '';
                document.getElementById('churchCity').value = church.city || '';
                document.getElementById('churchPastor').value = church.pastor || '';
                document.getElementById('churchPhone').value = church.phone || '';
                document.getElementById('churchRuc').value = church.pastor_ruc || '';
                document.getElementById('churchCedula').value = church.pastor_cedula || '';
                document.getElementById('churchGrado').value = church.pastor_grado || '';
                document.getElementById('churchPosicion').value = church.pastor_posicion || '';
                document.getElementById('churchActive').checked = church.active !== false;

                document.getElementById('churchModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading church data:', error);
                showToast('Error', 'Error al cargar datos de la iglesia', 'error');
            }
        }

        async function toggleChurchStatus(churchId) {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const church = response.data.find(c => c.id === churchId);
                if (!church) {
                    showToast('Error', 'Iglesia no encontrada', 'error');
                    return;
                }

                await axios.put(`${API_BASE}/churches?id=${churchId}`, {
                    ...church,
                    active: !church.active
                }, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Estado de la iglesia actualizado', 'success');
                loadChurches();

            } catch (error) {
                console.error('Error toggling church status:', error);
                showToast('Error', 'Error al actualizar el estado de la iglesia', 'error');
            }
        }

        // Handle church form submission
        document.getElementById('churchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const churchId = document.getElementById('churchId').value;
            const formData = {
                name: document.getElementById('churchName').value,
                city: document.getElementById('churchCity').value,
                pastor: document.getElementById('churchPastor').value,
                phone: document.getElementById('churchPhone').value,
                ruc: document.getElementById('churchRuc').value,
                cedula: document.getElementById('churchCedula').value,
                grado: document.getElementById('churchGrado').value,
                posicion: document.getElementById('churchPosicion').value,
                active: document.getElementById('churchActive').checked
            };

            try {
                if (churchId) {
                    // Update existing church
                    await axios.put(`${API_BASE}/churches?id=${churchId}`, formData, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    showToast('Éxito', 'Iglesia actualizada correctamente', 'success');
                } else {
                    // Create new church
                    await axios.post(`${API_BASE}/churches`, formData, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });
                    showToast('Éxito', 'Iglesia creada correctamente', 'success');
                }

                closeChurchModal();
                loadChurches();

            } catch (error) {
                console.error('Error saving church:', error);
                showToast('Error', error.response?.data?.error || 'Error al guardar la iglesia', 'error');
            }
        });

        // ===========================
        // MONTHLY LEDGER FUNCTIONS
        // ===========================

        // Global state for monthly ledger
        let currentLedgerData = null;
        let currentChurchId = null;
        let currentYear = null;
        let currentMonth = null;
        let expenseManualTax = { iva10: false, iva5: false };

        // Load monthly ledger tab
        async function loadMonthlyLedgerTab() {
            await loadChurchesForLedger();
            populateYearOptions();

            // Set current month/year as default
            const now = new Date();
            document.getElementById('ledgerYear').value = now.getFullYear();
            document.getElementById('ledgerMonth').value = now.getMonth() + 1;
        }

        // Load churches for the ledger dropdown
        async function loadChurchesForLedger() {
            try {
                const response = await axios.get(`${API_BASE}/churches`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const churchSelect = document.getElementById('ledgerChurch');
                churchSelect.innerHTML = '<option value="">Seleccionar Iglesia</option>';

                response.data.churches.forEach(church => {
                    const option = document.createElement('option');
                    option.value = church.id;
                    option.textContent = `${church.name} - ${church.city}`;
                    churchSelect.appendChild(option);
                });

                const defaultChurchId = currentUser?.churchId ? String(currentUser.churchId) : '';
                if (defaultChurchId) {
                    churchSelect.value = defaultChurchId;
                    churchSelect.disabled = currentUser?.role === 'church';
                } else {
                    churchSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading churches:', error);
                showToast('Error', 'No se pudieron cargar las iglesias', 'error');
            }
        }

        // Populate year options
        function populateYearOptions() {
            const yearSelect = document.getElementById('ledgerYear');
            const currentYear = new Date().getFullYear();

            yearSelect.innerHTML = '<option value="">Año</option>';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Load monthly ledger data
        async function loadMonthlyLedger() {
            const churchId = document.getElementById('ledgerChurch').value;
            const year = document.getElementById('ledgerYear').value;
            const month = document.getElementById('ledgerMonth').value;

            if (!churchId || !year || !month) {
                showToast('Error', 'Debe seleccionar iglesia, año y mes', 'error');
                return;
            }

            await fetchAndRenderLedger({ churchId, year, month });
        }

        // Update ledger overview cards
        function updateLedgerOverview() {
            if (!currentLedgerData) return;

            const { entradas, distribucion_automatica, gastos, balance } = currentLedgerData;

            document.getElementById('ledgerTotalEntradas').textContent = formatCurrency(entradas.totales.total_entradas);
            document.getElementById('ledgerFondoNacional').textContent = formatCurrency(distribucion_automatica.fondo_nacional_10_percent);
            document.getElementById('ledgerDisponibleLocal').textContent = formatCurrency(distribucion_automatica.disponible_local_90_percent);
            document.getElementById('ledgerTotalGastos').textContent = formatCurrency(gastos.totales.total_gastos);

            const balanceElement = document.getElementById('ledgerBalance');
            balanceElement.textContent = formatCurrency(balance.saldo_calculado);

            // Color code the balance
            if (Math.abs(balance.saldo_calculado) < 1) {
                balanceElement.className = 'text-2xl font-bold text-green-600';
            } else if (balance.saldo_calculado < 0) {
                balanceElement.className = 'text-2xl font-bold text-red-600';
            } else {
                balanceElement.className = 'text-2xl font-bold text-orange-600';
            }
        }

        // Update period title
        function updateLedgerPeriodTitle() {
            if (!currentLedgerData) return;

            const { periodo } = currentLedgerData;
            document.getElementById('ledgerPeriodTitle').textContent = periodo.descripcion;
        }

        // Update balance status message
        function updateLedgerBalanceStatus() {
            if (!currentLedgerData) return;

            const { balance } = currentLedgerData;
            const statusElement = document.getElementById('ledgerBalanceStatus');

            let statusClass = '';
            let statusIcon = '';

            switch (balance.status) {
                case 'balanceado':
                    statusClass = 'text-green-600 bg-green-50 border-green-200';
                    statusIcon = '✅';
                    break;
                case 'deficit':
                    statusClass = 'text-red-600 bg-red-50 border-red-200';
                    statusIcon = '⚠️';
                    break;
                case 'pendiente_factura_pastoral':
                    statusClass = 'text-yellow-600 bg-yellow-50 border-yellow-200';
                    statusIcon = '📄';
                    break;
                default:
                    statusClass = 'text-blue-600 bg-blue-50 border-blue-200';
                    statusIcon = 'ℹ️';
            }

            statusElement.innerHTML = `
                <div class="p-3 rounded-lg border ${statusClass}">
                    <span class="mr-2">${statusIcon}</span>
                    <strong>Estado:</strong> ${balance.mensaje}
                </div>
            `;
        }

        // Show specific ledger step
        function showLedgerStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.add('hidden');
            });

            // Remove active class from all step buttons
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected step
            document.getElementById(`ledgerStep${stepNumber}`).classList.remove('hidden');
            document.getElementById(`step${stepNumber === 1 ? 'Cultos' : stepNumber === 2 ? 'Gastos' : 'Cierre'}Btn`).classList.add('active');

            // Load step-specific content
            switch (stepNumber) {
                case 1:
                    loadWorshipRecords();
                    break;
                case 2:
                    loadExpenseRecords();
                    break;
                case 3:
                    updateReviewStep();
                    break;
            }
        }

        async function fetchAndRenderLedger({ churchId, year, month, showToastSuccess = true }) {
            currentChurchId = churchId;
            currentYear = year;
            currentMonth = month;

            try {
                const response = await axios.get(`${API_BASE}/monthly-ledger`, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    params: { church_id: churchId, year, month }
                });

                currentLedgerData = response.data;

                document.getElementById('monthlyLedgerContent').classList.remove('hidden');

                updateLedgerOverview();
                updateLedgerPeriodTitle();
                updateLedgerBalanceStatus();

                await loadWorshipRecords();
                await loadExpenseRecords();
                updateReviewStep();

                if (showToastSuccess) {
                    showToast('Éxito', 'Período cargado correctamente', 'success');
                }

            } catch (error) {
                console.error('Error loading monthly ledger:', error);
                showToast('Error', 'No se pudo cargar el período seleccionado', 'error');
                throw error;
            }
        }

        // Load worship records for step 1
        async function loadWorshipRecords() {
            if (!currentChurchId || !currentYear || !currentMonth) {
                return;
            }

            try {
                const response = await axios.get(`${API_BASE}/worship-records`, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    params: {
                        church_id: currentChurchId,
                        year: currentYear,
                        month: currentMonth
                    }
                });

                const records = response.data.records || [];
                const recordsList = document.getElementById('worshipRecordsList');

                if (!records.length) {
                    recordsList.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-lg text-center">
                            <p class="text-gray-600">No hay registros de cultos para este período.</p>
                            <p class="text-sm text-gray-500 mt-2">Haga clic en "Agregar Culto" para comenzar.</p>
                        </div>
                    `;
                    return;
                }

                recordsList.innerHTML = records.map(record => {
                    const total = parseFloat(record.total_recaudado || 0);
                    const diezmado = parseFloat(record.total_diezmos || 0);
                    const ofrendado = parseFloat(record.total_ofrendas || 0);
                    const misiones = parseFloat(record.total_misiones || 0);
                    const otros = parseFloat(record.total_otros || 0);
                    const anonimo = parseFloat(record.ofrenda_general_anonima || 0);

                    return `
                        <div class="border rounded-lg p-4 hover:shadow-sm transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-base font-semibold text-gray-900">${escapeHtml(formatDate(record.fecha_culto))} · ${escapeHtml(record.tipo_culto)}</h4>
                                    <p class="text-sm text-gray-600">Predicador: ${escapeHtml(record.predicador || 'No registrado')}</p>
                                    <p class="text-sm text-gray-600">Recaudado: <span class="font-medium">${formatCurrency(total)}</span></p>
                                    <p class="text-xs text-gray-500">Diezmos: ${formatCurrency(diezmado)} · Ofrendas: ${formatCurrency(ofrendado)} · Misiones: ${formatCurrency(misiones)} · Otros: ${formatCurrency(otros)} · Anónima: ${formatCurrency(anonimo)}</p>
                                </div>
                                <span class="text-xs text-gray-500">${record.contributions.length} aportes</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading worship records:', error);
                showToast('Error', 'No se pudieron cargar los cultos del mes', 'error');
            }
        }

        // Load expense records for step 2
        async function loadExpenseRecords() {
            if (!currentChurchId || !currentYear || !currentMonth) {
                return;
            }

            const recordsList = document.getElementById('expenseRecordsList');
            const expenseSummary = document.getElementById('expenseSummary');

            try {
                const response = await axios.get(`${API_BASE}/expense-records`, {
                    headers: { Authorization: `Bearer ${authToken}` },
                    params: {
                        church_id: currentChurchId,
                        year: currentYear,
                        month: currentMonth
                    }
                });

                const expenses = response.data.records || [];

                if (!expenses.length) {
                    recordsList.innerHTML = `
                        <div class="p-4 bg-gray-50 rounded-lg text-center">
                            <p class="text-gray-600">No hay gastos registrados para este período.</p>
                            <p class="text-sm text-gray-500 mt-2">Use los botones arriba para agregar gastos.</p>
                        </div>
                    `;
                    expenseSummary.innerHTML = '<p class="text-sm text-gray-500">Sin movimientos registrados.</p>';
                    return;
                }

                const categoryLabels = {
                    servicios_basicos: 'Servicios Básicos',
                    honorarios: 'Honorarios',
                    ministerio: 'Ministerio',
                    materiales: 'Materiales',
                    mantenimiento: 'Mantenimiento',
                    otros: 'Otros'
                };

                const totals = { total: 0 };

                expenses.forEach(expense => {
                    const amount = parseFloat(expense.total_factura || 0);
                    const category = expense.expense_category || 'otros';
                    totals[category] = (totals[category] || 0) + amount;
                    totals.total += amount;
                });

                recordsList.innerHTML = expenses.map(expense => {
                    const amount = parseFloat(expense.total_factura || 0);
                    const category = expense.expense_category || 'otros';
                    const provider = expense.proveedor ? escapeHtml(expense.proveedor) : 'Proveedor no registrado';
                    const concepto = expense.concepto ? escapeHtml(expense.concepto) : 'Sin detalle';
                    const numero = expense.numero_comprobante ? `Factura Nº ${escapeHtml(expense.numero_comprobante)}` : 'Sin número de comprobante';
                    const fecha = formatDate(expense.fecha_comprobante);
                    const categoryLabel = categoryLabels[category] || category;
                    const badge = expense.es_honorario_pastoral ? '<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">Honorario Pastoral</span>' : '';

                    return `
                        <div class="border rounded-lg p-4 hover:shadow-sm transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-base font-semibold text-gray-900">${provider}${badge}</h4>
                                    <p class="text-sm text-gray-600">${concepto}</p>
                                    <p class="text-xs text-gray-500">${numero} · ${categoryLabel} · ${fecha}</p>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">${formatCurrency(amount)}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                const summaryHtml = Object.entries(categoryLabels)
                    .map(([key, label]) => {
                        const value = totals[key] || 0;
                        return `
                            <div class="flex justify-between">
                                <span>${label}:</span>
                                <span class="font-semibold">${formatCurrency(value)}</span>
                            </div>
                        `;
                    }).join('');

                expenseSummary.innerHTML = `
                    ${summaryHtml}
                    <hr class="my-2">
                    <div class="flex justify-between font-bold">
                        <span>Total del Mes:</span>
                        <span>${formatCurrency(totals.total)}</span>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading expense records:', error);
                showToast('Error', 'No se pudieron cargar los gastos del mes', 'error');
            }
        }

        // Update review step (step 3)
        function updateReviewStep() {
            if (!currentLedgerData) return;

            const { entradas, gastos, salario_pastoral, balance } = currentLedgerData;

            // Update income summary
            const incomeSummary = document.getElementById('incomeSummary');
            incomeSummary.innerHTML = `
                <div class="flex justify-between">
                    <span>Diezmos:</span>
                    <span class="font-semibold">${formatCurrency(entradas.totales.diezmos)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Ofrendas:</span>
                    <span class="font-semibold">${formatCurrency(entradas.totales.ofrendas)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Misiones:</span>
                    <span class="font-semibold">${formatCurrency(entradas.totales.misiones)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Otros:</span>
                    <span class="font-semibold">${formatCurrency(entradas.totales.otros)}</span>
                </div>
                <hr class="my-2">
                <div class="flex justify-between font-bold">
                    <span>Total:</span>
                    <span>${formatCurrency(entradas.totales.total_entradas)}</span>
                </div>
            `;

            // Update national fund distribution
            const nationalFundSummary = document.getElementById('nationalFundSummary');
            if (nationalFundSummary && currentLedgerData.distribucion_automatica) {
                const { fondo_nacional_10_percent, disponible_local_90_percent, porcentaje_fondo_nacional } = currentLedgerData.distribucion_automatica;
                nationalFundSummary.innerHTML = `
                    <div class="flex justify-between">
                        <span>Total Entradas (Diezmos + Ofrendas):</span>
                        <span class="font-semibold">${formatCurrency(entradas.totales.total_entradas)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Fondo Nacional (10%):</span>
                        <span class="font-semibold text-purple-600">${formatCurrency(fondo_nacional_10_percent)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Disponible Local (90%):</span>
                        <span class="font-semibold text-green-600">${formatCurrency(disponible_local_90_percent)}</span>
                    </div>
                    <hr class="my-2">
                    <div class="text-sm text-gray-600">
                        <p>✓ El 10% se envía automáticamente al fondo nacional</p>
                        <p>✓ El 90% queda para gastos locales y salario pastoral</p>
                    </div>
                `;
            }

            // Update expense summary
            const expenseSummary = document.getElementById('expenseSummary');
            expenseSummary.innerHTML = `
                <div class="flex justify-between">
                    <span>Servicios Básicos:</span>
                    <span class="font-semibold">${formatCurrency(gastos.totales.servicios_basicos)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Otros Gastos:</span>
                    <span class="font-semibold">${formatCurrency(gastos.totales.otros_gastos)}</span>
                </div>
                <hr class="my-2">
                <div class="flex justify-between font-bold">
                    <span>Total:</span>
                    <span>${formatCurrency(gastos.totales.total_gastos)}</span>
                </div>
            `;

            // Update pastor salary summary
            const pastorSalarySummary = document.getElementById('pastorSalarySummary');
            pastorSalarySummary.innerHTML = `
                <div class="flex justify-between">
                    <span>Calculado Automático:</span>
                    <span class="font-semibold">${formatCurrency(salario_pastoral.calculado_automatico)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Registrado en Facturas:</span>
                    <span class="font-semibold">${formatCurrency(salario_pastoral.registrado_en_facturas)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Diferencia:</span>
                    <span class="font-semibold ${salario_pastoral.diferencia === 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(salario_pastoral.diferencia)}
                    </span>
                </div>
            `;

            // Show/hide generate invoice section
            const generateInvoiceSection = document.getElementById('generateInvoiceSection');
            if (salario_pastoral.diferencia > 0) {
                generateInvoiceSection.classList.remove('hidden');
            } else {
                generateInvoiceSection.classList.add('hidden');
            }

            // Update final balance
            const finalBalanceDisplay = document.getElementById('finalBalanceDisplay');
            finalBalanceDisplay.innerHTML = `
                <span class="${Math.abs(balance.saldo_calculado) < 1 ? 'text-green-600' : balance.saldo_calculado < 0 ? 'text-red-600' : 'text-orange-600'}">
                    ${formatCurrency(balance.saldo_calculado)}
                </span>
            `;

            // Update close button state
            const closeMonthBtn = document.getElementById('closeMonthBtn');
            closeMonthBtn.disabled = false;
            closeMonthBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            closeMonthBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            if (balance.puede_cerrar) {
                closeMonthBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                closeMonthBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            }

            // Show closure messages
            const closureMessages = document.getElementById('closureMessages');
            if (balance.requiere_accion) {
                let detailedMessages = [];

                // Check for missing income
                if (entradas.totales.total_entradas === 0) {
                    detailedMessages.push('❌ No hay entradas registradas para este mes');
                }

                // Check for pastor salary discrepancy
                if (salario_pastoral.diferencia > 0) {
                    detailedMessages.push(`⚠️ Falta registrar factura pastoral por ${formatCurrency(salario_pastoral.diferencia)}`);
                    detailedMessages.push('→ Use el botón "Generar Factura Pastoral" para crear la factura');
                }

                // Check for balance issues
                if (Math.abs(balance.saldo_calculado) > 1) {
                    if (balance.saldo_calculado < 0) {
                        detailedMessages.push(`❌ Déficit de ${formatCurrency(Math.abs(balance.saldo_calculado))}`);
                        detailedMessages.push('→ Los gastos exceden los ingresos disponibles');
                    } else {
                        detailedMessages.push(`⚠️ Superávit de ${formatCurrency(balance.saldo_calculado)}`);
                        detailedMessages.push('→ Hay fondos sin asignar que deben ser distribuidos');
                    }
                }

                closureMessages.innerHTML = `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 font-semibold">Acciones Requeridas para Cerrar el Mes:</p>
                        <ul class="text-yellow-700 text-sm mt-2 space-y-1">
                            ${detailedMessages.map(msg => `<li>${msg}</li>`).join('')}
                        </ul>
                        <div class="mt-3 pt-3 border-t border-yellow-200">
                            <p class="text-xs text-yellow-600">Principio de Balance Cero: Ingresos - 10% Fondo Nacional - Gastos - Salario Pastor = 0</p>
                        </div>
                    </div>
                `;
            } else if (balance.puede_cerrar) {
                closureMessages.innerHTML = `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-green-800 font-semibold">✅ Mes listo para cerrar</p>
                        <ul class="text-green-700 text-sm mt-2 space-y-1">
                            <li>✓ Todas las entradas han sido registradas</li>
                            <li>✓ Todos los gastos han sido documentados</li>
                            <li>✓ El salario pastoral está correctamente facturado</li>
                            <li>✓ El balance del mes es CERO (cumple el principio de balance cero)</li>
                            <li>✓ 10% enviado automáticamente al fondo nacional: ${formatCurrency(currentLedgerData.distribucion_automatica.fondo_nacional_10_percent)}</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Worship Record Modal Functions
        function openWorshipRecordModal() {
            document.getElementById('worshipRecordModal').classList.remove('hidden');

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('worshipDate').value = today;

            // Initialize contributions table
            resetContributionsTable();
        }

        function closeWorshipRecordModal() {
            document.getElementById('worshipRecordModal').classList.add('hidden');
            document.getElementById('worshipRecordForm').reset();
            resetContributionsTable();
        }

        function resetContributionsTable() {
            const contributionsBody = document.getElementById('contributionsTableBody');
            contributionsBody.innerHTML = '';
            addContributionRow(); // Add first empty row
            updateContributionTotals();
        }

        function addContributionRow() {
            const contributionsBody = document.getElementById('contributionsTableBody');
            const rowCount = contributionsBody.children.length + 1;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-2">${rowCount}</td>
                <td class="px-4 py-2">
                    <div class="donor-autocomplete relative">
                        <input type="text" class="donor-input w-full px-2 py-1 border rounded"
                               placeholder="Buscar donante..."
                               oninput="searchDonors(this)"
                               onblur="setTimeout(() => hideDonorSuggestions(this), 200)">
                        <div class="donor-suggestions absolute z-10 w-full bg-white border rounded shadow-lg hidden mt-1 max-h-40 overflow-y-auto"></div>
                        <input type="hidden" class="donor-id">
                    </div>
                </td>
                <td class="px-4 py-2">
                    <input type="text" class="ci-ruc w-full px-2 py-1 border rounded" placeholder="CI/RUC">
                </td>
                <td class="px-4 py-2">
                    <input type="text" class="receipt-number w-full px-2 py-1 border rounded" placeholder="# Recibo">
                </td>
                <td class="px-4 py-2">
                    <select class="fund-bucket w-full px-2 py-1 border rounded" onchange="updateContributionTotals()">
                        ${FUND_OPTIONS_HTML}
                    </select>
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="fund-amount w-full px-2 py-1 border rounded" min="0" step="100" value="0"
                           oninput="updateContributionTotals()" onchange="updateContributionTotals()">
                </td>
                <td class="px-4 py-2 text-center">
                    <button type="button" onclick="removeContributionRow(this)" class="text-red-600 hover:text-red-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </td>
            `;
            contributionsBody.appendChild(row);
            enhanceFormControls(row);
            updateRowNumbers();
            updateContributionTotals();
        }

        function removeContributionRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;

            if (tbody.children.length > 1) {
                row.remove();
                updateRowNumbers();
                updateContributionTotals();
            }
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#contributionsTableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        function updateContributionTotals() {
            const rows = document.querySelectorAll('#contributionsTableBody tr');
            const totalsByBucket = new Map();

            rows.forEach(row => {
                const bucket = row.querySelector('.fund-bucket')?.value;
                const amount = parseFloat(row.querySelector('.fund-amount')?.value) || 0;
                if (!bucket || amount <= 0) {
                    return;
                }
                totalsByBucket.set(bucket, (totalsByBucket.get(bucket) || 0) + amount);
            });

            const anonymousOfferingInput = document.querySelector('input[name="anonymousOffering"]');
            const anonymousOffering = anonymousOfferingInput ? parseFloat(anonymousOfferingInput.value) || 0 : 0;
            if (anonymousOffering > 0) {
                totalsByBucket.set('ofrenda', (totalsByBucket.get('ofrenda') || 0) + anonymousOffering);
            }

            let national10Total = 0;
            let national100Total = 0;
            let localTotal = 0;

            FUND_BUCKETS.forEach(({ value, group }) => {
                const bucketTotal = totalsByBucket.get(value) || 0;
                if (group === 'national10') {
                    national10Total += bucketTotal;
                } else if (group === 'national100') {
                    national100Total += bucketTotal;
                } else {
                    localTotal += bucketTotal;
                }
            });

            const grandTotal = national10Total + national100Total + localTotal;

            document.getElementById('summaryNational10').textContent = formatCurrency(national10Total);
            document.getElementById('summaryNational100').textContent = formatCurrency(national100Total);
            document.getElementById('summaryLocal').textContent = formatCurrency(localTotal);
            document.getElementById('summaryTotal').textContent = formatCurrency(grandTotal);
        }

        // Donor autocomplete functionality
        let donorSearchTimeout;

        async function searchDonors(input) {
            const query = input.value.trim();
            const suggestionsDiv = input.parentNode.querySelector('.donor-suggestions');

            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            // Clear previous timeout
            clearTimeout(donorSearchTimeout);

            // Debounce search
            donorSearchTimeout = setTimeout(async () => {
                try {
                    const churchId = getCurrentChurchId();
                    const response = await axios.get(`${API_BASE}/donors/search?church_id=${churchId}&q=${encodeURIComponent(query)}`, {
                        headers: { Authorization: `Bearer ${authToken}` }
                    });

                    displayDonorSuggestions(suggestionsDiv, response.data.donors || []);
                } catch (error) {
                    console.error('Error searching donors:', error);
                    suggestionsDiv.classList.add('hidden');
                }
            }, 300);
        }

        function displayDonorSuggestions(suggestionsDiv, donors) {
            suggestionsDiv.innerHTML = '';

            if (!donors.length) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            donors.forEach(donor => {
                const suggestion = document.createElement('div');
                suggestion.className = 'donor-suggestion p-2 hover:bg-gray-100 cursor-pointer border-b';

                const nameEl = document.createElement('div');
                nameEl.className = 'font-semibold';
                nameEl.textContent = donor.nombre_completo;
                suggestion.appendChild(nameEl);

                const docEl = document.createElement('div');
                docEl.className = 'text-sm text-gray-600';
                docEl.textContent = donor.ci_ruc ? `CI/RUC: ${donor.ci_ruc}` : 'CI/RUC no registrado';
                suggestion.appendChild(docEl);

                if (donor.estadisticas) {
                    const statsEl = document.createElement('div');
                    statsEl.className = 'text-xs text-blue-600';
                    const lastDate = donor.estadisticas.ultima_contribucion ? formatDate(donor.estadisticas.ultima_contribucion) : 'Sin registros';
                    const yearTotal = formatCurrency(donor.estadisticas.total_año_actual || 0);
                    statsEl.textContent = `Última: ${lastDate} · Año: ${yearTotal}`;
                    suggestion.appendChild(statsEl);
                }

                suggestion.addEventListener('mousedown', (event) => {
                    event.preventDefault();
                    const autocomplete = suggestionsDiv.closest('.donor-autocomplete');
                    applyDonorSelection(autocomplete, {
                        id: donor.id,
                        nombre: donor.nombre_completo,
                        ciRuc: donor.ci_ruc
                    });
                });

                suggestionsDiv.appendChild(suggestion);
            });

            suggestionsDiv.classList.remove('hidden');
        }

        function applyDonorSelection(autocomplete, donor) {
            if (!autocomplete) return;
            const input = autocomplete.querySelector('.donor-input');
            const hiddenId = autocomplete.querySelector('.donor-id');
            const ciRucInput = autocomplete.closest('tr').querySelector('.ci-ruc');

            input.value = donor.nombre;
            hiddenId.value = donor.id || '';
            ciRucInput.value = donor.ciRuc || '';

            hideDonorSuggestions(autocomplete);
        }

        function hideDonorSuggestions(target) {
            const autocomplete = target?.classList?.contains('donor-autocomplete')
                ? target
                : target?.closest?.('.donor-autocomplete');
            if (!autocomplete) {
                return;
            }
            const suggestionsDiv = autocomplete.querySelector('.donor-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.classList.add('hidden');
            }
        }

        async function saveWorshipRecord() {
            try {
                const form = document.getElementById('worshipRecordForm');
                const formData = new FormData(form);

                const contributions = [];
                const rows = document.querySelectorAll('#contributionsTableBody tr');

                rows.forEach(row => {
                    const donorName = row.querySelector('.donor-input').value.trim();
                    const donorIdValue = row.querySelector('.donor-id').value;
                    const donorId = donorIdValue ? parseInt(donorIdValue, 10) : null;
                    const ciRuc = row.querySelector('.ci-ruc').value.trim();
                    const receiptNumber = row.querySelector('.receipt-number').value.trim();
                    const bucket = row.querySelector('.fund-bucket').value;
                    const amount = parseFloat(row.querySelector('.fund-amount').value) || 0;

                    if (!donorName && amount <= 0) {
                        return;
                    }

                    const contribution = {
                        donor_id: donorId,
                        nombre_aportante: donorName,
                        ci_ruc: ciRuc || null,
                        numero_recibo: receiptNumber || null,
                        diezmo: 0,
                        ofrenda: 0,
                        misiones: 0,
                        lazos_amor: 0,
                        mision_posible: 0,
                        apy: 0,
                        instituto_biblico: 0,
                        diezmo_pastoral: 0,
                        caballeros: 0,
                        damas: 0,
                        jovenes: 0,
                        ninos: 0,
                        anexos: 0,
                        otros: 0,
                        total: amount
                    };

                    if (Object.prototype.hasOwnProperty.call(contribution, bucket)) {
                        contribution[bucket] = amount;
                    } else {
                        console.error('Invalid fund bucket selected:', bucket);
                        showToast('Error', `Fondo desconocido seleccionado: ${bucket}`, 'error');
                        throw new Error(`Invalid fund bucket: ${bucket}`);
                    }

                    contributions.push(contribution);
                });

                const anonymousOffering = parseFloat(formData.get('anonymousOffering')) || 0;

                if (!contributions.length && anonymousOffering <= 0) {
                    showToast('Error', 'Debe registrar al menos una contribución o una ofrenda anónima', 'error');
                    return;
                }

                const churchId = getCurrentChurchId();
                if (!churchId) {
                    showToast('Error', 'Seleccione una iglesia válida antes de registrar el culto', 'error');
                    return;
                }

                const worshipData = {
                    church_id: churchId,
                    fecha_culto: formData.get('worshipDate'),
                    tipo_culto: formData.get('worshipType'),
                    predicador: formData.get('preacher'),
                    miembros_activos: parseInt(formData.get('activeMembers')) || 0,
                    visitas: parseInt(formData.get('visitors')) || 0,
                    ninos: parseInt(formData.get('children')) || 0,
                    jovenes: parseInt(formData.get('youth')) || 0,
                    bautismos_agua: parseInt(formData.get('waterBaptisms')) || 0,
                    bautismos_espiritu: parseInt(formData.get('spiritBaptisms')) || 0,
                    ofrenda_general_anonima: anonymousOffering,
                    observaciones: formData.get('observations'),
                    contributions
                };

                const response = await axios.post(`${API_BASE}/worship-records`, worshipData, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Culto registrado correctamente', 'success');

                closeWorshipRecordModal();
                resetContributionsTable();

                if (currentChurchId && currentYear && currentMonth && String(currentChurchId) === String(worshipData.church_id)) {
                    try {
                        await fetchAndRenderLedger({
                            churchId: currentChurchId,
                            year: currentYear,
                            month: currentMonth,
                            showToastSuccess: false
                        });
                    } catch (refreshError) {
                        console.warn('No se pudo refrescar el libro mensual automáticamente:', refreshError);
                    }
                } else {
                    await loadWorshipRecords();
                }

                return response.data;

            } catch (error) {
                console.error('Error saving worship record:', error);
                const message = error.response?.data?.error || 'Error al guardar el registro de culto';
                showToast('Error', message, 'error');
                throw error;
            }
        }

        function getCurrentChurchId() {
            const ledgerChurch = document.getElementById('ledgerChurch');
            if (ledgerChurch && ledgerChurch.value) {
                return ledgerChurch.value;
            }
            if (currentUser?.churchId) {
                return currentUser.churchId;
            }
            return null;
        }

        function openExpenseModal(category = 'otros', provider = '') {
            resetExpenseForm();
            expenseManualTax = { iva10: false, iva5: false };

            const today = new Date();
            const defaultDate = currentYear && currentMonth
                ? new Date(currentYear, currentMonth - 1, today.getDate())
                : today;

            document.getElementById('expenseDate').value = defaultDate.toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = category;
            document.getElementById('expenseProvider').value = provider || '';
            document.getElementById('expenseRuc').value = '';
            document.getElementById('expenseInvoice').value = '';
            document.getElementById('expenseType').value = category === 'servicios_basicos' ? provider : '';
            document.getElementById('expenseConcept').value = provider ? `Pago de ${provider}` : '';
            document.getElementById('expensePastoral').checked = category === 'honorarios';

            updateExpenseModalTotals();

            document.getElementById('expenseRecordModal').classList.remove('hidden');
        }

        function closeExpenseModal() {
            document.getElementById('expenseRecordModal').classList.add('hidden');
        }

        function resetExpenseForm() {
            const form = document.getElementById('expenseRecordForm');
            if (!form) return;
            form.reset();
            document.getElementById('expenseAmountExempt').value = 0;
            document.getElementById('expenseAmountTax10').value = 0;
            document.getElementById('expenseTax10').value = 0;
            document.getElementById('expenseAmountTax5').value = 0;
            document.getElementById('expenseTax5').value = 0;
            document.getElementById('expenseTotalDisplay').textContent = formatCurrency(0);
        }

        function markManualTaxChange(event) {
            if (event?.target?.id === 'expenseTax10') {
                expenseManualTax.iva10 = true;
            }
            if (event?.target?.id === 'expenseTax5') {
                expenseManualTax.iva5 = true;
            }
            updateExpenseModalTotals();
        }

        function updateExpenseModalTotals() {
            const exemptInput = document.getElementById('expenseAmountExempt');
            const gravada10Input = document.getElementById('expenseAmountTax10');
            const iva10Input = document.getElementById('expenseTax10');
            const gravada5Input = document.getElementById('expenseAmountTax5');
            const iva5Input = document.getElementById('expenseTax5');
            const totalDisplay = document.getElementById('expenseTotalDisplay');

            const exenta = parseFloat(exemptInput.value) || 0;
            const gravada10 = parseFloat(gravada10Input.value) || 0;
            const gravada5 = parseFloat(gravada5Input.value) || 0;

            if (!expenseManualTax.iva10) {
                iva10Input.value = Math.round(gravada10 * 0.1);
            }
            if (!expenseManualTax.iva5) {
                iva5Input.value = Math.round(gravada5 * 0.05);
            }

            const iva10 = parseFloat(iva10Input.value) || 0;
            const iva5 = parseFloat(iva5Input.value) || 0;

            const total = exenta + gravada10 + iva10 + gravada5 + iva5;
            totalDisplay.textContent = formatCurrency(total);
        }

        function handleExpensePastoralToggle() {
            const checkbox = document.getElementById('expensePastoral');
            const categorySelect = document.getElementById('expenseCategory');
            if (checkbox.checked) {
                categorySelect.value = 'honorarios';
            }
        }

        async function saveExpenseRecord() {
            try {
                const date = document.getElementById('expenseDate').value;
                const category = document.getElementById('expenseCategory').value;
                const provider = document.getElementById('expenseProvider').value.trim();
                const concept = document.getElementById('expenseConcept').value.trim();

                if (!date) {
                    showToast('Error', 'Debe ingresar la fecha del comprobante', 'error');
                    return;
                }
                if (!provider) {
                    showToast('Error', 'Debe ingresar el proveedor', 'error');
                    return;
                }
                if (!concept) {
                    showToast('Error', 'Debe ingresar el concepto del gasto', 'error');
                    return;
                }

                const payload = {
                    church_id: getCurrentChurchId(),
                    fecha_comprobante: date,
                    expense_category: category,
                    proveedor: provider,
                    ruc_ci_proveedor: document.getElementById('expenseRuc').value.trim() || null,
                    numero_comprobante: document.getElementById('expenseInvoice').value.trim() || null,
                    tipo_salida: document.getElementById('expenseType').value.trim() || null,
                    concepto: concept,
                    monto_exenta: parseFloat(document.getElementById('expenseAmountExempt').value) || 0,
                    monto_gravada_10: parseFloat(document.getElementById('expenseAmountTax10').value) || 0,
                    iva_10: parseFloat(document.getElementById('expenseTax10').value) || 0,
                    monto_gravada_5: parseFloat(document.getElementById('expenseAmountTax5').value) || 0,
                    iva_5: parseFloat(document.getElementById('expenseTax5').value) || 0,
                    es_honorario_pastoral: document.getElementById('expensePastoral').checked,
                    observaciones: null
                };

                if (!payload.church_id) {
                    showToast('Error', 'Seleccione una iglesia válida antes de registrar el gasto', 'error');
                    return;
                }

                payload.total_factura = payload.monto_exenta + payload.monto_gravada_10 + payload.iva_10 + payload.monto_gravada_5 + payload.iva_5;

                const response = await axios.post(`${API_BASE}/expense-records`, payload, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Gasto registrado correctamente', 'success');
                closeExpenseModal();

                if (currentChurchId && currentYear && currentMonth && String(currentChurchId) === String(payload.church_id)) {
                    try {
                        await fetchAndRenderLedger({
                            churchId: currentChurchId,
                            year: currentYear,
                            month: currentMonth,
                            showToastSuccess: false
                        });
                    } catch (refreshError) {
                        console.warn('No se pudo refrescar el libro mensual automáticamente:', refreshError);
                    }
                } else {
                    await loadExpenseRecords();
                }

                return response.data;

            } catch (error) {
                console.error('Error saving expense record:', error);
                const message = error.response?.data?.error || 'Error al guardar el gasto';
                showToast('Error', message, 'error');
            }
        }

        async function generatePastorInvoice() {
            if (!currentLedgerData) return;

            const { salario_pastoral, iglesia } = currentLedgerData;

            if (!salario_pastoral || salario_pastoral.diferencia <= 0) {
                showToast('Error', 'No hay diferencia de salario pastoral para generar factura', 'error');
                return;
            }

            const monthNames = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthName = monthNames[currentMonth];

            const invoiceNumber = prompt(`Ingrese el número de factura del Pastor ${iglesia.pastor}:`);
            if (!invoiceNumber) return;

            try {
                const payload = {
                    church_id: currentChurchId,
                    fecha_comprobante: `${currentYear}-${String(currentMonth).padStart(2, '0')}-${new Date().getDate()}`,
                    numero_comprobante: invoiceNumber,
                    ruc_ci_proveedor: iglesia.pastor_ruc || '',
                    proveedor: `Pastor ${iglesia.pastor}`,
                    concepto: `Honorarios Pastorales - ${monthName} ${currentYear}`,
                    expense_category: 'honorarios',
                    monto_exenta: salario_pastoral.diferencia,
                    monto_gravada_10: 0,
                    iva_10: 0,
                    monto_gravada_5: 0,
                    iva_5: 0,
                    total_factura: salario_pastoral.diferencia,
                    es_factura_legal: true,
                    es_honorario_pastoral: true,
                    observaciones: `Factura generada automáticamente para balance del mes ${monthName} ${currentYear}`
                };

                const response = await axios.post(`${API_BASE}/expense-records`, payload, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', 'Factura pastoral generada correctamente', 'success');

                // Refresh the ledger data to show updated balance
                await fetchAndRenderLedger({
                    churchId: currentChurchId,
                    year: currentYear,
                    month: currentMonth,
                    showToastSuccess: false
                });

            } catch (error) {
                console.error('Error generando factura pastoral:', error);
                const errorMsg = error.response?.data?.error || 'Error al generar factura pastoral';
                showToast('Error', errorMsg, 'error');
            }
        }

        async function closeMonth(force = false) {
            if (!currentChurchId || !currentYear || !currentMonth) {
                showToast('Error', 'Debe seleccionar un período antes de cerrar el mes', 'error');
                return;
            }

            if (!currentLedgerData) {
                showToast('Error', 'Cargue el período antes de cerrar el mes', 'error');
                return;
            }

            if (!currentLedgerData.balance.puede_cerrar && !force) {
                const confirmForce = confirm(`${currentLedgerData.balance.mensaje}.\n\n¿Desea forzar el cierre igualmente?`);
                if (!confirmForce) {
                    return;
                }
                force = true;
            }

            const closeMonthBtn = document.getElementById('closeMonthBtn');
            const originalText = closeMonthBtn.textContent;
            closeMonthBtn.disabled = true;
            closeMonthBtn.textContent = 'Cerrando...';

            try {
                const response = await axios.post(`${API_BASE}/monthly-ledger/close`, {
                    church_id: currentChurchId,
                    year: currentYear,
                    month: currentMonth,
                    force_close: force
                }, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                showToast('Éxito', response.data.message || 'Mes cerrado correctamente', 'success');

                if (response.data.ledger) {
                    currentLedgerData = response.data.ledger;
                }

                await fetchAndRenderLedger({
                    churchId: currentChurchId,
                    year: currentYear,
                    month: currentMonth,
                    showToastSuccess: false
                });

            } catch (error) {
                console.error('Error closing month:', error);
                const data = error.response?.data;
                const message = data?.error || data?.razon || 'No se pudo cerrar el mes';
                showToast('Error', message, 'error');

                if (data?.sugerencias?.length) {
                    const closureMessages = document.getElementById('closureMessages');
                    closureMessages.innerHTML = `
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-yellow-800 font-semibold">Sugerencias:</p>
                            <ul class="mt-1 text-sm text-yellow-700 list-disc pl-4">
                                ${data.sugerencias.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

            } finally {
                closeMonthBtn.disabled = false;
                closeMonthBtn.textContent = originalText;
            }
        }

        function exportMonthlyReport() {
            showToast('Información', 'Función en desarrollo: Exportar reporte', 'info');
        }

        // Setup contextual shortcuts once accessibility layer is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', registerContextShortcuts);
        } else {
            registerContextShortcuts();
        }

        // Start the application
        init();
    </script>

    <!-- Worship Record Modal -->
    <div id="worshipRecordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Registrar Culto y Contribuciones</h3>
                    <button onclick="closeWorshipRecordModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="worshipRecordForm" class="space-y-6">
                    <!-- Worship Details Section -->
                    <div class="border-b pb-6">
                        <h4 class="text-md font-semibold mb-4">Información del Culto</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="worshipDate" name="worshipDate" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Culto</label>
                                <select name="worshipType" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Seleccionar...</option>
                                    <option value="dominical_mañana">Dominical Mañana</option>
                                    <option value="dominical_noche">Dominical Noche</option>
                                    <option value="miercoles">Miércoles</option>
                                    <option value="viernes">Viernes</option>
                                    <option value="sabado">Sábado</option>
                                    <option value="especial">Culto Especial</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Predicador</label>
                                <input type="text" name="preacher" placeholder="Nombre del predicador"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Section -->
                    <div class="border-b pb-6">
                        <h4 class="text-md font-semibold mb-4">Asistencia</h4>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Miembros Activos</label>
                                <input type="number" name="activeMembers" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Visitas</label>
                                <input type="number" name="visitors" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Niños</label>
                                <input type="number" name="children" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jóvenes</label>
                                <input type="number" name="youth" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ofrenda Anónima</label>
                                <input type="number" name="anonymousOffering" min="0" step="100" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       oninput="updateContributionTotals()" onchange="updateContributionTotals()">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bautismos en Agua</label>
                                <input type="number" name="waterBaptisms" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bautismos del Espíritu</label>
                                <input type="number" name="spiritBaptisms" min="0" placeholder="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Contributions Section -->
                    <div class="pb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-semibold">Contribuciones Individuales</h4>
                            <button type="button" onclick="addContributionRow()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                + Agregar Fila
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300" role="table" aria-label="Contribuciones individuales del culto">
                                <caption class="absd-sr-only">Listado de contribuciones individuales registradas en el culto seleccionado</caption>
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Donante</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">CI/RUC</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"># Recibo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fondo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto (Gs)</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="contributionsTableBody" class="divide-y divide-gray-200">
                                    <!-- Rows added dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>10% Nacional (Diezmos/Ofrendas): <span id="summaryNational10" class="font-semibold">₲ 0</span></div>
                                <div>100% Nacional (Misiones/APY/etc.): <span id="summaryNational100" class="font-semibold">₲ 0</span></div>
                                <div>Fondos Locales: <span id="summaryLocal" class="font-semibold">₲ 0</span></div>
                            </div>
                            <div class="mt-2 text-lg font-bold">Total Recaudado: <span id="summaryTotal" class="text-blue-600">₲ 0</span></div>
                        </div>
                    </div>

                    <!-- Observations -->
                    <div class="pb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                        <textarea name="observations" rows="3" placeholder="Observaciones adicionales sobre el culto..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeWorshipRecordModal()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancelar
                        </button>
                        <button type="button" onclick="saveWorshipRecord()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Record Modal -->
    <div id="expenseRecordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-24 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Registrar Gasto Mensual</h3>
                <button onclick="closeExpenseModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="expenseRecordForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha del comprobante</label>
                        <input type="date" id="expenseDate" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="expenseCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="servicios_basicos">Servicios Básicos</option>
                            <option value="honorarios">Honorarios</option>
                            <option value="ministerio">Ministerio</option>
                            <option value="materiales">Materiales</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                        <input type="text" id="expenseProvider" placeholder="Nombre del proveedor" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CI / RUC</label>
                        <input type="text" id="expenseRuc" placeholder="RUC del proveedor"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número de factura</label>
                        <input type="text" id="expenseInvoice" placeholder="000-000-000000"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de salida (opcional)</label>
                        <input type="text" id="expenseType" placeholder="Servicio, compra, etc."
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                    <textarea id="expenseConcept" rows="3" placeholder="Detalle del gasto"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Monto Exenta</label>
                        <input type="number" id="expenseAmountExempt" min="0" step="100" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="updateExpenseModalTotals()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gravada 10%</label>
                        <input type="number" id="expenseAmountTax10" min="0" step="100" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="updateExpenseModalTotals()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IVA 10%</label>
                        <input type="number" id="expenseTax10" min="0" step="100" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="markManualTaxChange(event)">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gravada 5%</label>
                        <input type="number" id="expenseAmountTax5" min="0" step="100" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="updateExpenseModalTotals()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">IVA 5%</label>
                        <input type="number" id="expenseTax5" min="0" step="100" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="markManualTaxChange(event)">
                    </div>
                    <div class="flex items-end">
                        <div class="w-full bg-gray-50 border border-gray-200 rounded-md px-3 py-2">
                            <span class="text-xs text-gray-500">Total estimado</span>
                            <div id="expenseTotalDisplay" class="text-lg font-semibold">₲ 0</div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="expensePastoral" onchange="handleExpensePastoralToggle()"
                           class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="expensePastoral" class="text-sm text-gray-700">Es honorario pastoral (factura del pastor)</label>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeExpenseModal()"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancelar
                    </button>
                    <button type="button" onclick="saveExpenseRecord()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Guardar Gasto
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>