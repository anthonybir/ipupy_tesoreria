<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPU PY - Contabilidad de Iglesia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/absd-tokens.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/absd-components.js"></script>
    <script src="/js/absd-data-pipeline.js"></script>
    <script src="/js/absd-state-manager.js"></script>
    <script src="/js/absd-charts.js"></script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sidebar-active {
            transform: translateX(0);
        }

        .sidebar-hidden {
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar-hidden {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="min-h-screen theme-light density-normal absd-disclosure-basic">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg relative z-50">
        <div class="absd-container py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebarToggle" class="md:hidden mr-4 p-2 rounded hover:bg-white/20">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold">Contabilidad de Iglesia</h1>
                        <p class="text-blue-100 text-sm" id="churchName">IPU Paraguay</p>
                    </div>
                </div>
                <div id="userInfo" class="flex items-center space-x-4">
                    <span id="userEmail" class="text-sm hidden md:block"></span>
                    <button onclick="logout()" class="bg-white/20 px-3 py-1 rounded hover:bg-white/30 transition text-sm">
                        Salir
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Acceso a Contabilidad</h2>
            <form id="loginForm" class="absd-form-grid">
                <div class="absd-form-row">
                    <label for="loginEmail" class="absd-label">Email <span class="required-dot" aria-hidden="true">*</span></label>
                    <input type="email" id="loginEmail" required class="absd-input" autocomplete="email">
                </div>
                <div class="absd-form-row">
                    <label for="loginPassword" class="absd-label">Contraseña <span class="required-dot" aria-hidden="true">*</span></label>
                    <input type="password" id="loginPassword" required class="absd-input" autocomplete="current-password">
                </div>
                <button type="submit" class="absd-btn absd-btn-primary w-full justify-center">
                    <span id="loginText">Iniciar Sesión</span>
                    <div id="loginLoading" class="loading hidden ml-2" aria-hidden="true"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="flex">
            <a href="#main-content" class="sr-only focus:not-sr-only">Saltar al contenido principal</a>
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar-hidden md:sidebar-active fixed md:static inset-y-0 left-0 z-40 w-64 bg-white shadow-lg transition-transform duration-300 ease-in-out">
                <div class="p-6 h-full overflow-y-auto">
                    <nav class="space-y-2">
                        <a href="#" onclick="showSection('dashboard')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            </svg>
                            <span>Panel Principal</span>
                        </a>
                        <a href="#" onclick="showSection('accounts')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <span>Cuentas Bancarias</span>
                        </a>
                        <a href="#" onclick="showSection('transactions')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <span>Transacciones</span>
                        </a>
                        <a href="#" onclick="showSection('categories')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                            <span>Categorías</span>
                        </a>
                        <a href="#" onclick="showSection('budget')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>Presupuesto</span>
                        </a>
                        <a href="#" onclick="showSection('reports')" class="nav-link flex items-center space-x-3 text-gray-600 p-3 rounded-lg hover:bg-gray-100 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Informes</span>
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-6 md:ml-0">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Panel Principal</h2>
                        <p class="text-gray-600">Resumen financiero de la iglesia</p>
                    </div>

                    <!-- Summary Cards -->
                    <div class="absd-grid mb-8" role="list">
                        <article class="absd-card absd-density-target absd-span-minimal border-l-4 border-green-500" role="listitem" data-dashboard-metric data-skeleton-type="metric">
                            <div class="flex items-center">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Total en Cuentas</p>
                                    <p class="text-2xl font-bold text-gray-900 number-morph" id="totalBalance">₲ 0</p>
                                </div>
                                <div class="p-3 bg-green-100 rounded-full">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                            </div>
                        </article>

                        <article class="absd-card absd-density-target absd-span-minimal border-l-4 border-blue-500" role="listitem" data-dashboard-metric data-skeleton-type="metric">
                            <div class="flex items-center">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Ingresos del Mes</p>
                                    <p class="text-2xl font-bold text-gray-900 number-morph" id="monthlyIncome">₲ 0</p>
                                </div>
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                    </svg>
                                </div>
                            </div>
                        </article>

                        <article class="absd-card absd-density-target absd-span-minimal border-l-4 border-red-500" role="listitem" data-dashboard-metric data-skeleton-type="metric">
                            <div class="flex items-center">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Gastos del Mes</p>
                                    <p class="text-2xl font-bold text-gray-900 number-morph" id="monthlyExpenses">₲ 0</p>
                                </div>
                                <div class="p-3 bg-red-100 rounded-full">
                                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                                    </svg>
                                </div>
                            </div>
                        </article>

                        <article class="absd-card absd-density-target absd-span-minimal border-l-4 border-purple-500" role="listitem" data-dashboard-metric data-skeleton-type="metric">
                            <div class="flex items-center">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Balance del Mes</p>
                                    <p class="text-2xl font-bold text-gray-900 number-morph" id="monthlyBalance">₲ 0</p>
                                </div>
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </article>
                    </div>

                    <!-- Charts Row -->
                    <div class="absd-grid mb-8">
                        <section class="absd-card absd-density-target absd-span-standard absd-chart-container" aria-labelledby="cashFlowHeading" data-dashboard-chart data-skeleton-type="card">
                            <h3 id="cashFlowHeading" class="text-lg font-semibold text-gray-800 mb-4">Flujo de Caja (Últimos 6 Meses)</h3>
                            <canvas id="cashFlowChart" height="200" role="img" aria-label="Gráfico de flujo de caja de los últimos seis meses"></canvas>
                            <div id="cashFlowChart_table" class="sr-only" aria-hidden="true"></div>
                        </section>
                        <section class="absd-card absd-density-target absd-span-standard absd-chart-container" aria-labelledby="expensesHeading" data-dashboard-chart data-skeleton-type="card">
                            <h3 id="expensesHeading" class="text-lg font-semibold text-gray-800 mb-4">Gastos por Categoría</h3>
                            <canvas id="expensesChart" height="200" role="img" aria-label="Gráfico de distribución de gastos por categoría"></canvas>
                            <div id="expensesChart_table" class="sr-only" aria-hidden="true"></div>
                        </section>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">Transacciones Recientes</h3>
                                <button onclick="showSection('transactions')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Ver todas →
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactions" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Accounts Section -->
                <div id="accountsSection" class="section hidden">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">Cuentas Bancarias</h2>
                                <p class="text-gray-600">Gestión de cuentas de la iglesia</p>
                            </div>
                            <button onclick="showNewAccountForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                + Nueva Cuenta
                            </button>
                        </div>
                    </div>

                    <!-- Accounts Grid -->
                    <div id="accountsGrid" class="absd-grid">
                        <!-- Dynamic content with ABSD span classes -->
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactionsSection" class="section hidden">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">Transacciones</h2>
                                <p class="text-gray-600">Registro detallado de ingresos y gastos</p>
                            </div>
                            <button onclick="showNewTransactionForm()" class="absd-btn absd-btn-primary">
                                + Nueva Transacción
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="absd-card absd-density-target absd-form-grid mb-6" data-skeleton-type="table">
                        <div class="absd-form-row split-4">
                            <div>
                                <label for="filterAccount" class="absd-label">Cuenta</label>
                                <select id="filterAccount" class="absd-select">
                                    <option value="">Todas las cuentas</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterType" class="absd-label">Tipo de movimiento</label>
                                <select id="filterType" class="absd-select">
                                    <option value="">Todos los tipos</option>
                                    <option value="income">Ingresos</option>
                                    <option value="expense">Gastos</option>
                                    <option value="transfer">Transferencias</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterStartDate" class="absd-label">Desde</label>
                                <input type="date" id="filterStartDate" class="absd-input">
                            </div>
                            <div>
                                <label for="filterEndDate" class="absd-label">Hasta</label>
                                <input type="date" id="filterEndDate" class="absd-input">
                            </div>
                        </div>
                        <div class="absd-form-row">
                            <button onclick="loadTransactions()" class="absd-btn absd-btn-primary">
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuenta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Other sections would be added here... -->
                <div id="categoriesSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Categorías de Transacciones</h2>
                    <p class="text-gray-600 mb-4">Aquí se mostrarían las categorías...</p>
                </div>

                <div id="budgetSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Presupuesto</h2>
                    <p class="text-gray-600 mb-4">Aquí se mostraría la gestión de presupuesto...</p>
                </div>

                <div id="reportsSection" class="section hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Informes Mensuales</h2>
                            <p class="text-gray-600">Revisa el estado de tus envíos y presenta el informe del mes en minutos.</p>
                        </div>
                        <button id="startReportWizardBtn" class="absd-btn absd-btn-primary flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Enviar Informe Mensual
                        </button>
                    </div>

                    <div id="reportSummaryCards" class="absd-grid mb-6" data-skeleton-type="card">
                        <!-- Se completa dinámicamente -->
                    </div>

                    <div class="bg-white rounded-lg shadow-md border mb-6">
                        <div class="p-6 border-b flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold">Historial de Informes</h3>
                                <p class="text-sm text-gray-500">Los informes más recientes aparecen primero.</p>
                            </div>
                            <select id="reportYearFilter" class="absd-select hidden md:block">
                                <!-- Opciones dinámicas -->
                            </select>
                        </div>
                        <div id="reportStatusListContainer" class="absd-virtual-panel" data-skeleton-type="table">
                            <div id="reportStatusList" class="absd-virtual-scroll" role="list" aria-live="polite">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">Línea de Tiempo</h3>
                            <p class="text-sm text-gray-500">Visualiza el recorrido desde el envío hasta la aprobación.</p>
                        </div>
                        <div id="reportTimeline" class="p-6 space-y-4" data-skeleton-type="text">
                            <!-- Timeline dinámico -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Report Wizard Modal -->
    <div id="reportWizardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-semibold">Enviar Informe Mensual</h3>
                        <p id="reportWizardStepLabel" class="text-sm text-gray-500">Paso 1 de 4</p>
                    </div>
                    <button id="closeReportWizardBtn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="px-6 pt-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2" id="reportWizardSteps">
                            <!-- Step indicators render dynamically -->
                        </div>
                        <div>
                            <span id="reportWizardWarnings" class="text-sm text-red-500"></span>
                        </div>
                    </div>
                </div>

                <form id="reportWizardForm" class="px-6 pb-6 space-y-6">
                    <div class="wizard-step" data-step="1">
                        <h4 class="text-lg font-semibold mb-3">1. Datos del Informe</h4>
                        <div class="absd-form-grid">
                            <div class="absd-form-row split-3">
                                <div>
                                    <label for="wizardYear" class="absd-label">Año</label>
                                    <input type="number" id="wizardYear" class="absd-input" min="2020" max="2035" required>
                                </div>
                                <div>
                                    <label for="wizardMonth" class="absd-label">Mes</label>
                                    <select id="wizardMonth" class="absd-select" required>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="wizardEstado" class="absd-label">Estado preliminar</label>
                                    <select id="wizardEstado" class="absd-select">
                                        <option value="pendiente">Pendiente</option>
                                        <option value="borrador">Borrador</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-step hidden" data-step="2">
                        <h4 class="text-lg font-semibold mb-3">2. Resumen de Entradas</h4>
                        <div class="absd-form-grid">
                            <div class="absd-form-row split-4">
                                <div>
                                    <label for="wizardDiezmos" class="absd-label">Diezmos (Gs.)</label>
                                    <input type="number" id="wizardDiezmos" class="absd-input" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label for="wizardOfrendas" class="absd-label">Ofrendas (Gs.)</label>
                                    <input type="number" id="wizardOfrendas" class="absd-input" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label for="wizardAnexos" class="absd-label">Anexos (Gs.)</label>
                                    <input type="number" id="wizardAnexos" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardCaballeros" class="absd-label">Caballeros (Gs.)</label>
                                    <input type="number" id="wizardCaballeros" class="absd-input" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="absd-form-row split-4">
                                <div>
                                    <label for="wizardDamas" class="absd-label">Damas (Gs.)</label>
                                    <input type="number" id="wizardDamas" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardJovenes" class="absd-label">Jóvenes (Gs.)</label>
                                    <input type="number" id="wizardJovenes" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardNinos" class="absd-label">Niños (Gs.)</label>
                                    <input type="number" id="wizardNinos" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardOtros" class="absd-label">Otros (Gs.)</label>
                                    <input type="number" id="wizardOtros" class="absd-input" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-blue-50 rounded">
                            <p class="text-sm text-blue-700">Total Entradas: <span id="wizardTotalEntradas" class="font-semibold">0</span></p>
                            <p class="text-sm text-blue-700">Fondo Nacional (10%): <span id="wizardFondoNacional" class="font-semibold">0</span></p>
                        </div>
                    </div>

                    <div class="wizard-step hidden" data-step="3">
                        <h4 class="text-lg font-semibold mb-3">3. Salidas y Depósito</h4>
                        <div class="absd-form-grid">
                            <div class="absd-form-row split-3">
                                <div>
                                    <label for="wizardHonorariosPastoral" class="absd-label">Honorarios Pastorales (Gs.)</label>
                                    <input type="number" id="wizardHonorariosPastoral" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardServicios" class="absd-label">Servicios Públicos (Gs.)</label>
                                    <input type="number" id="wizardServicios" class="absd-input" step="0.01" min="0">
                                </div>
                                <div>
                                    <label for="wizardMontoDepositado" class="absd-label">Monto Depositado (Gs.)</label>
                                    <input type="number" id="wizardMontoDepositado" class="absd-input" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="absd-form-row split-3">
                                <div>
                                    <label for="wizardFechaDeposito" class="absd-label">Fecha de Depósito</label>
                                    <input type="date" id="wizardFechaDeposito" class="absd-input">
                                </div>
                                <div>
                                    <label for="wizardNumeroDeposito" class="absd-label">Número de Boleta</label>
                                    <input type="text" id="wizardNumeroDeposito" class="absd-input">
                                </div>
                            </div>
                            <div class="absd-form-row split-3">
                                <div>
                                    <label for="wizardAsistenciaVisitas" class="absd-label">Asistencia de Visitas</label>
                                    <input type="number" id="wizardAsistenciaVisitas" class="absd-input" min="0">
                                </div>
                                <div>
                                    <label for="wizardBautismosAgua" class="absd-label">Bautismos en Agua</label>
                                    <input type="number" id="wizardBautismosAgua" class="absd-input" min="0">
                                </div>
                                <div>
                                    <label for="wizardBautismosEspiritu" class="absd-label">Bautismos Espíritu Santo</label>
                                    <input type="number" id="wizardBautismosEspiritu" class="absd-input" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-step hidden" data-step="4">
                        <h4 class="text-lg font-semibold mb-3">4. Revisar y Adjuntar</h4>
                        <div class="absd-form-grid mb-4">
                            <div class="absd-form-row split-2">
                                <div>
                                    <label for="wizardResumenFile" class="absd-label">Resumen Financiero (Foto)</label>
                                    <input type="file" id="wizardResumenFile" accept="image/*" class="absd-input">
                                </div>
                                <div>
                                    <label for="wizardDepositoFile" class="absd-label">Comprobante de Depósito (Foto)</label>
                                    <input type="file" id="wizardDepositoFile" accept="image/*" class="absd-input">
                                </div>
                            </div>
                        </div>
                        <div class="absd-form-grid">
                            <div class="absd-form-row">
                                <div>
                                    <label for="wizardObservaciones" class="absd-label">Observaciones</label>
                                    <textarea id="wizardObservaciones" class="absd-textarea" rows="4" placeholder="Notas adicionales, aclaraciones o comentarios"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded" id="wizardReview">
                            <!-- Resumen dinámico -->
                        </div>
                    </div>

                    <div class="flex justify-between pt-4 border-t">
                        <button type="button" id="reportWizardBackBtn" class="absd-btn absd-btn-ghost">Atrás</button>
                        <div class="flex gap-2">
                            <button type="button" id="reportWizardSaveDraftBtn" class="absd-btn absd-btn-ghost hidden">Guardar Borrador</button>
                            <button type="button" id="reportWizardNextBtn" class="absd-btn absd-btn-primary">Siguiente</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <script>
        const API_BASE = window.location.origin;
        const API_ENDPOINTS = {
            auth: '/api/auth',
            reports: '/api/reports',
            dashboard: '/api/dashboard'
        };

        let authToken = null;
        let currentUser = null;
        let currentChurch = null;
        let reportHistory = [];
        let reportWizardState = null;
        let cashFlowChartInstance = null;
        let expensesChartInstance = null;
        let reportListScroller = null;

        const REPORT_WIZARD_STEPS = [
            { id: 1, label: 'Datos' },
            { id: 2, label: 'Entradas' },
            { id: 3, label: 'Salidas' },
            { id: 4, label: 'Revisión' }
        ];

        function getStoredToken() {
            return localStorage.getItem('authToken');
        }

        function setAuthToken(token) {
            authToken = token;
            if (token) {
                localStorage.setItem('authToken', token);
            } else {
                localStorage.removeItem('authToken');
            }
        }

        async function restoreUserContext() {
            if (!authToken) {
                return;
            }
            try {
                const response = await axios.get(`${API_BASE}${API_ENDPOINTS.auth}?action=verify`, {
                    headers: getAuthHeaders()
                });
                const user = response.data?.user;
                if (user) {
                    currentUser = user;
                    currentChurch = user.churchId ? {
                        id: user.churchId,
                        name: user.churchName || 'Iglesia IPUPY'
                    } : null;
                    document.getElementById('userEmail').textContent = currentUser.email || '';
                    if (currentChurch?.name) {
                        document.getElementById('churchName').textContent = currentChurch.name;
                    }
                }
            } catch (error) {
                console.warn('No se pudo restaurar la sesión', error);
            }
        }

        function getAuthHeaders() {
            return authToken ? { Authorization: `Bearer ${authToken}` } : {};
        }

        function notify(message, type = 'success') {
            if (type === 'error') {
                console.error(message);
                alert(message);
            } else {
                console.log(message);
            }
        }

        function enhanceFormControls(root = document) {
            const INPUT_SELECTOR = 'input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="tel"], input[type="url"], input[type="search"], input:not([type])';
            const legacyClasses = ['px-3', 'py-2', 'border', 'border-gray-300', 'border-gray-200', 'rounded', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring', 'focus:ring-blue-500'];

            root.querySelectorAll(INPUT_SELECTOR).forEach((input) => {
                if (!input.classList.contains('absd-input') && !input.classList.contains('absd-input--skip')) {
                    input.classList.add('absd-input');
                }
                legacyClasses.forEach(cls => input.classList.remove(cls));
            });

            root.querySelectorAll('select').forEach((select) => {
                if (!select.classList.contains('absd-select') && !select.classList.contains('absd-input--skip')) {
                    select.classList.add('absd-select');
                }
                legacyClasses.forEach(cls => select.classList.remove(cls));
            });

            root.querySelectorAll('textarea').forEach((textarea) => {
                if (!textarea.classList.contains('absd-textarea') && !textarea.classList.contains('absd-input--skip')) {
                    textarea.classList.add('absd-textarea');
                }
                legacyClasses.forEach(cls => textarea.classList.remove(cls));
            });

            const labelLegacyClasses = ['block', 'text-sm', 'font-medium', 'text-gray-700', 'text-gray-600', 'mb-1'];
            root.querySelectorAll('label').forEach((label) => {
                if (!label.classList.contains('absd-label') && !label.classList.contains('absd-label--skip')) {
                    label.classList.add('absd-label');
                }
                labelLegacyClasses.forEach(cls => label.classList.remove(cls));
            });
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
            const target = document.getElementById(`${sectionName}Section`);
            if (target) {
                target.classList.remove('hidden');
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-blue-100', 'text-blue-700');
                link.classList.add('text-gray-600');
                const handler = link.getAttribute('onclick') || '';
                if (handler.includes(`'${sectionName}'`)) {
                    link.classList.add('bg-blue-100', 'text-blue-700');
                    link.classList.remove('text-gray-600');
                }
            });

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('sidebar-hidden');
            }

            if (sectionName === 'reports') {
                renderReportSummaryCards();
                renderReportList();
                renderReportTimeline();
            }
        }

        function logout() {
            setAuthToken(null);
            currentUser = null;
            currentChurch = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        document.getElementById('sidebarToggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-hidden');
            sidebar.classList.toggle('sidebar-active');
        });

        function defaultReportWizardState() {
            const now = new Date();
            return {
                step: 1,
                form: {
                    year: now.getFullYear(),
                    month: now.getMonth() + 1,
                    estado: 'pendiente',
                    diezmos: 0,
                    ofrendas: 0,
                    anexos: 0,
                    caballeros: 0,
                    damas: 0,
                    jovenes: 0,
                    ninos: 0,
                    otros: 0,
                    honorarios_pastoral: 0,
                    servicios: 0,
                    monto_depositado: 0,
                    fecha_deposito: '',
                    numero_deposito: '',
                    asistencia_visitas: 0,
                    bautismos_agua: 0,
                    bautismos_espiritu: 0,
                    observaciones: ''
                },
                attachments: {
                    summary: null,
                    deposit: null
                }
            };
        }

        function openReportWizard() {
            reportWizardState = defaultReportWizardState();
            syncWizardForm();
            updateWizardUI();
            const modal = document.getElementById('reportWizardModal');
            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeReportWizard() {
            const modal = document.getElementById('reportWizardModal');
            reportWizardState = null;
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
        }

        function syncWizardForm() {
            if (!reportWizardState) return;
            const form = reportWizardState.form;
            document.getElementById('wizardYear').value = form.year;
            document.getElementById('wizardMonth').value = form.month;
            document.getElementById('wizardEstado').value = form.estado;
            document.getElementById('wizardDiezmos').value = form.diezmos;
            document.getElementById('wizardOfrendas').value = form.ofrendas;
            document.getElementById('wizardAnexos').value = form.anexos;
            document.getElementById('wizardCaballeros').value = form.caballeros;
            document.getElementById('wizardDamas').value = form.damas;
            document.getElementById('wizardJovenes').value = form.jovenes;
            document.getElementById('wizardNinos').value = form.ninos;
            document.getElementById('wizardOtros').value = form.otros;
            document.getElementById('wizardHonorariosPastoral').value = form.honorarios_pastoral;
            document.getElementById('wizardServicios').value = form.servicios;
            document.getElementById('wizardMontoDepositado').value = form.monto_depositado;
            document.getElementById('wizardFechaDeposito').value = form.fecha_deposito;
            document.getElementById('wizardNumeroDeposito').value = form.numero_deposito;
            document.getElementById('wizardAsistenciaVisitas').value = form.asistencia_visitas;
            document.getElementById('wizardBautismosAgua').value = form.bautismos_agua;
            document.getElementById('wizardBautismosEspiritu').value = form.bautismos_espiritu;
            document.getElementById('wizardObservaciones').value = form.observaciones;
            updateWizardTotals();
        }

        function updateWizardUI() {
            if (!reportWizardState) return;
            const step = reportWizardState.step;
            document.querySelectorAll('#reportWizardForm .wizard-step').forEach(el => {
                const stepNumber = parseInt(el.getAttribute('data-step'), 10);
                el.classList.toggle('hidden', stepNumber !== step);
            });

            const backBtn = document.getElementById('reportWizardBackBtn');
            const nextBtn = document.getElementById('reportWizardNextBtn');
            const draftBtn = document.getElementById('reportWizardSaveDraftBtn');
            const stepLabel = document.getElementById('reportWizardStepLabel');

            backBtn.disabled = step === 1;
            backBtn.classList.toggle('opacity-50', step === 1);
            backBtn.classList.toggle('cursor-not-allowed', step === 1);

            nextBtn.textContent = step === REPORT_WIZARD_STEPS.length ? 'Enviar Informe' : 'Siguiente';
            draftBtn.classList.toggle('hidden', step !== REPORT_WIZARD_STEPS.length);
            stepLabel.textContent = `Paso ${step} de ${REPORT_WIZARD_STEPS.length}`;

            const stepsContainer = document.getElementById('reportWizardSteps');
            stepsContainer.innerHTML = REPORT_WIZARD_STEPS.map(({ id, label }) => {
                const isActive = id === step;
                const isCompleted = id < step;
                const base = 'px-3 py-1 rounded-full text-sm font-semibold border';
                const palette = isActive
                    ? 'bg-blue-600 text-white border-blue-600'
                    : isCompleted
                        ? 'bg-green-100 text-green-700 border-green-300'
                        : 'bg-gray-100 text-gray-500 border-gray-200';
                return `<span class="${base} ${palette}">${id}. ${label}</span>`;
            }).join('');

            if (step === REPORT_WIZARD_STEPS.length) {
                renderWizardReview();
            }
        }

        function updateWizardTotals() {
            if (!reportWizardState) return;
            const incomeFields = ['diezmos', 'ofrendas', 'anexos', 'caballeros', 'damas', 'jovenes', 'ninos', 'otros'];
            incomeFields.forEach(field => {
                const value = parseFloat(document.getElementById(`wizard${capitalize(field)}`).value || '0');
                reportWizardState.form[field] = value;
            });

            const totalEntradas = incomeFields.reduce((sum, field) => sum + (reportWizardState.form[field] || 0), 0);
            const fondoNacional = totalEntradas * 0.1;

            reportWizardState.form.honorarios_pastoral = parseFloat(document.getElementById('wizardHonorariosPastoral').value || '0');
            reportWizardState.form.servicios = parseFloat(document.getElementById('wizardServicios').value || '0');
            reportWizardState.form.monto_depositado = parseFloat(document.getElementById('wizardMontoDepositado').value || '0');

            document.getElementById('wizardTotalEntradas').textContent = formatCurrency(totalEntradas);
            document.getElementById('wizardFondoNacional').textContent = formatCurrency(fondoNacional);
        }

        function renderWizardReview() {
            if (!reportWizardState) return;
            const form = reportWizardState.form;
            const totalEntradas = ['diezmos', 'ofrendas', 'anexos', 'caballeros', 'damas', 'jovenes', 'ninos', 'otros']
                .reduce((sum, field) => sum + (form[field] || 0), 0);
            const fondoNacional = totalEntradas * 0.1;
            const totalSalidas = fondoNacional + (form.honorarios_pastoral || 0) + (form.servicios || 0);

            document.getElementById('wizardReview').innerHTML = `
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div>
                        <dt class="font-semibold text-gray-600">Periodo</dt>
                        <dd>${formatMonthName(form.month)} ${form.year}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Estado</dt>
                        <dd>${formatStatus(form.estado)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Total Entradas</dt>
                        <dd>${formatCurrency(totalEntradas)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Fondo Nacional</dt>
                        <dd>${formatCurrency(fondoNacional)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Honorarios Pastorales</dt>
                        <dd>${formatCurrency(form.honorarios_pastoral || 0)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Servicios</dt>
                        <dd>${formatCurrency(form.servicios || 0)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Monto Depositado</dt>
                        <dd>${formatCurrency(form.monto_depositado || 0)}</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-gray-600">Observaciones</dt>
                        <dd>${form.observaciones ? form.observaciones : 'Sin observaciones'}</dd>
                    </div>
                </dl>
            `;
        }

        async function handleWizardFileChange(inputId, attachmentKey) {
            if (!reportWizardState) return;
            const input = document.getElementById(inputId);
            if (!input || !input.files || !input.files[0]) {
                reportWizardState.attachments[attachmentKey] = null;
                return;
            }
            const file = input.files[0];
            reportWizardState.attachments[attachmentKey] = await readFileAsDataURL(file);
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function validateWizardStep(step) {
            const warningEl = document.getElementById('reportWizardWarnings');
            warningEl.textContent = '';

            if (step === 1) {
                const year = parseInt(document.getElementById('wizardYear').value, 10);
                const month = parseInt(document.getElementById('wizardMonth').value, 10);
                if (!year || !month) {
                    warningEl.textContent = 'Seleccione año y mes válidos.';
                    return false;
                }
                reportWizardState.form.year = year;
                reportWizardState.form.month = month;
                reportWizardState.form.estado = document.getElementById('wizardEstado').value || 'pendiente';
            }

            if (step === 2) {
                updateWizardTotals();
            }

            if (step === 3) {
                reportWizardState.form.honorarios_pastoral = parseFloat(document.getElementById('wizardHonorariosPastoral').value || '0');
                reportWizardState.form.servicios = parseFloat(document.getElementById('wizardServicios').value || '0');
                reportWizardState.form.monto_depositado = parseFloat(document.getElementById('wizardMontoDepositado').value || '0');
                reportWizardState.form.fecha_deposito = document.getElementById('wizardFechaDeposito').value || '';
                reportWizardState.form.numero_deposito = document.getElementById('wizardNumeroDeposito').value || '';
                reportWizardState.form.asistencia_visitas = parseInt(document.getElementById('wizardAsistenciaVisitas').value || '0', 10);
                reportWizardState.form.bautismos_agua = parseInt(document.getElementById('wizardBautismosAgua').value || '0', 10);
                reportWizardState.form.bautismos_espiritu = parseInt(document.getElementById('wizardBautismosEspiritu').value || '0', 10);
            }

            if (step === 4) {
                reportWizardState.form.observaciones = document.getElementById('wizardObservaciones').value || '';
            }

            return true;
        }

        async function submitReportWizard(asDraft = false) {
            if (!reportWizardState) return;
            const form = reportWizardState.form;
            const payload = {
                month: form.month,
                year: form.year,
                estado: asDraft ? 'borrador' : form.estado,
                submission_type: 'online',
                diezmos: form.diezmos,
                ofrendas: form.ofrendas,
                anexos: form.anexos,
                caballeros: form.caballeros,
                damas: form.damas,
                jovenes: form.jovenes,
                ninos: form.ninos,
                otros: form.otros,
                honorarios_pastoral: form.honorarios_pastoral,
                servicios: form.servicios,
                monto_depositado: form.monto_depositado,
                fecha_deposito: form.fecha_deposito,
                numero_deposito: form.numero_deposito,
                asistencia_visitas: form.asistencia_visitas,
                bautismos_agua: form.bautismos_agua,
                bautismos_espiritu: form.bautismos_espiritu,
                observaciones: form.observaciones,
                attachments: reportWizardState.attachments
            };

            try {
                await axios.post(`${API_BASE}${API_ENDPOINTS.reports}`, payload, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                notify('Informe enviado correctamente');
                closeReportWizard();
                await loadMyReports();
                showSection('reports');
            } catch (error) {
                console.error('Error enviando informe:', error);
                notify(error.response?.data?.error || 'No se pudo enviar el informe', 'error');
            }
        }

        function renderReportSummaryCards() {
            const container = document.getElementById('reportSummaryCards');
            if (!container) return;
            const total = reportHistory.length;
            const pendientes = reportHistory.filter(r => r.estado === 'pendiente').length;
            const procesados = reportHistory.filter(r => r.estado === 'procesado').length;
            const borradores = reportHistory.filter(r => r.estado === 'borrador').length;

            const cards = [
                { title: 'Informes enviados', value: total, color: 'text-blue-600', description: 'Total acumulado de informes registrados.' },
                { title: 'Pendientes', value: pendientes, color: 'text-yellow-600', description: 'En espera de revisión del tesorero.' },
                { title: 'Procesados', value: procesados, color: 'text-green-600', description: 'Informes aprobados y conciliados.' },
                { title: 'Borradores', value: borradores, color: 'text-gray-600', description: 'Guardados para continuar luego.' }
            ];

            container.innerHTML = cards.map(card => `
                <div class="bg-white border rounded-lg p-5 shadow-sm">
                    <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">${card.title}</h4>
                    <p class="text-3xl font-bold ${card.color} mt-2">${card.value}</p>
                    <p class="text-sm text-gray-500 mt-1">${card.description}</p>
                </div>
            `).join('');
        }

        function renderReportList() {
            const containerEl = document.getElementById('reportStatusListContainer');
            const listEl = document.getElementById('reportStatusList');
            const yearFilterEl = document.getElementById('reportYearFilter');
            if (!listEl || !yearFilterEl) return;

            if (containerEl) {
                ABSD.pipeline.hideSkeleton(containerEl);
            }

            const years = [...new Set(reportHistory.map(r => r.year).filter(Boolean))].sort((a, b) => b - a);
            const previousYearValue = yearFilterEl.value;
            yearFilterEl.innerHTML = '<option value="">Todos los años</option>' + years.map(year => `<option value="${year}">${year}</option>`).join('');
            if (previousYearValue && years.includes(parseInt(previousYearValue, 10))) {
                yearFilterEl.value = previousYearValue;
            }
            const selectedYear = yearFilterEl.value ? parseInt(yearFilterEl.value, 10) : null;

            const rows = (selectedYear ? reportHistory.filter(r => r.year === selectedYear) : reportHistory)
                .slice()
                .sort(sortReportsByDate);

            if (!rows.length) {
                if (reportListScroller) {
                    reportListScroller.destroy();
                    reportListScroller = null;
                }
                listEl.innerHTML = '<div class="absd-data-empty">Aún no registraste informes para este periodo.</div>';
                return;
            }

            const renderItem = (report) => {
                const submittedAt = report.submitted_at || report.created_at;
                const processedAt = report.processed_at;
                const total = parseFloat(report.total_entradas || report.totalEntradas || 0);
                const statusLabel = formatStatus(report.estado);
                const statusClass = statusChipClasses(report.estado);
                return `
                    <article class="absd-virtual-item" role="listitem">
                        <div>
                            <p class="text-sm text-gray-500">${escapeHtml(formatMonthName(report.month))} ${escapeHtml(report.year)}</p>
                            <p class="text-lg font-semibold text-gray-800">${formatCurrency(total)}</p>
                            <p class="text-sm text-gray-500">${submittedAt ? 'Enviado el ' + escapeHtml(formatDateTime(submittedAt)) : 'Fecha de envío no disponible'}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusClass}">${escapeHtml(statusLabel)}</span>
                            ${processedAt ? `<span class="text-xs text-gray-500">Procesado el ${escapeHtml(formatDateTime(processedAt))}</span>` : ''}
                        </div>
                    </article>
                `;
            };

            if (!reportListScroller) {
                listEl.innerHTML = '';
                reportListScroller = new ABSD.VirtualScroller(listEl, {
                    itemHeight: 140,
                    threshold: 60,
                    renderItem
                });
            } else {
                reportListScroller.options.renderItem = renderItem;
            }

            reportListScroller.setItems(rows);
        }

        function renderReportTimeline() {
            const timelineEl = document.getElementById('reportTimeline');
            if (!timelineEl) return;
            if (!reportHistory.length) {
                timelineEl.innerHTML = '<div class="text-center text-gray-500">Cuando envíes tu primer informe, verás aquí el recorrido completo.</div>';
                return;
            }
            timelineEl.innerHTML = reportHistory.slice().sort(sortReportsByDate).slice(0, 8).map(report => {
                const submittedAt = report.submitted_at || report.created_at;
                const processedAt = report.processed_at;
                const accent = report.estado === 'procesado' ? 'border-green-400' : 'border-blue-300';
                const dot = report.estado === 'procesado' ? 'bg-green-500' : 'bg-blue-400';
                return `
                    <div class="relative pl-6 border-l-2 ${accent}">
                        <span class="absolute -left-2 top-1 w-3 h-3 rounded-full ${dot}"></span>
                        <p class="text-sm text-gray-500">${formatMonthName(report.month)} ${report.year}</p>
                        <p class="font-semibold text-gray-800">${formatStatus(report.estado)}</p>
                        <p class="text-sm text-gray-500">${submittedAt ? 'Enviado ' + formatDateTime(submittedAt) : 'Fecha de envío no disponible'}</p>
                        ${processedAt ? `<p class="text-sm text-gray-500">Procesado ${formatDateTime(processedAt)}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function sortReportsByDate(a, b) {
            const dateA = new Date(a.submitted_at || a.created_at || 0).getTime();
            const dateB = new Date(b.submitted_at || b.created_at || 0).getTime();
            return dateB - dateA;
        }

        async function loadMyReports() {
            const summaryContainer = document.getElementById('reportSummaryCards');
            const listContainer = document.getElementById('reportStatusListContainer');
            const timelineContainer = document.getElementById('reportTimeline');

            [summaryContainer, listContainer, timelineContainer].forEach((el) => {
                if (el) {
                    ABSD.pipeline.showSkeleton(el);
                }
            });

            try {
                const response = await axios.get(`${API_BASE}${API_ENDPOINTS.reports}`, {
                    headers: getAuthHeaders()
                });
                reportHistory = Array.isArray(response.data) ? response.data : [];
                renderReportSummaryCards();
                renderReportList();
                renderReportTimeline();
            } catch (error) {
                console.error('Error al cargar informes:', error);
                notify('No se pudieron cargar los informes', 'error');
            } finally {
                [summaryContainer, listContainer, timelineContainer].forEach((el) => {
                    if (el) {
                        ABSD.pipeline.hideSkeleton(el);
                    }
                });
            }
        }

        async function loadDashboardData() {
            const metricCards = document.querySelectorAll('[data-dashboard-metric]');
            const chartPanels = document.querySelectorAll('[data-dashboard-chart]');
            metricCards.forEach(card => ABSD.pipeline.showSkeleton(card));
            chartPanels.forEach(panel => ABSD.pipeline.showSkeleton(panel));

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            try {
                const ledgerPromise = currentChurch?.id
                    ? ABSD.pipeline.fetch(`${API_BASE}/api/accounting?type=ledger&church_id=${currentChurch.id}&month=${currentMonth}&year=${currentYear}`, {
                        headers: getAuthHeaders(),
                        container: null,
                        forceRefresh: true
                    }).catch((error) => {
                        console.warn('No se pudo cargar el libro mensual', error);
                        return null;
                    })
                    : Promise.resolve(null);

                const dashboardPromise = ABSD.pipeline.fetch(`${API_BASE}${API_ENDPOINTS.dashboard}`, {
                    headers: getAuthHeaders(),
                    container: null,
                    forceRefresh: true
                }).catch((error) => {
                    console.warn('Panel resumido aún no disponible.', error);
                    return null;
                });

                const [ledgerData, dashboardRaw] = await Promise.all([ledgerPromise, dashboardPromise]);
                const dashboardData = dashboardRaw?.data || dashboardRaw || {};

                const totalsFromLedger = ledgerData?.entradas?.totales;
                const expensesFromLedger = ledgerData?.gastos?.totales;
                const balanceFromLedger = ledgerData?.balance;

                const totalBalance = Array.isArray(dashboardData?.fund_overview)
                    ? dashboardData.fund_overview.reduce((sum, fund) => sum + Number(fund.current_balance || 0), 0)
                    : 0;

                const monthlyIncome = totalsFromLedger?.total_entradas ?? (
                    Number(dashboardData?.current_month?.tithes || 0) +
                    Number(dashboardData?.current_month?.offerings || 0) +
                    Number(dashboardData?.current_month?.national_fund || 0)
                );

                const monthlyExpenses = expensesFromLedger?.total_gastos ?? Number(dashboardData?.current_month?.national_fund || 0);
                const monthlyBalance = balanceFromLedger?.saldo_calculado ?? (monthlyIncome - monthlyExpenses);

                const updateMetric = (id, value, formatter) => {
                    const element = document.getElementById(id);
                    if (!element) return;
                    const container = element.closest('[data-dashboard-metric]');
                    if (container) {
                        ABSD.pipeline.hideSkeleton(container);
                    }
                    const formattedValue = formatter ? formatter(value) : value;
                    element.textContent = formattedValue;
                };

                updateMetric('totalBalance', totalBalance, formatCurrency);
                updateMetric('monthlyIncome', monthlyIncome, formatCurrency);
                updateMetric('monthlyExpenses', monthlyExpenses, formatCurrency);
                updateMetric('monthlyBalance', monthlyBalance, formatCurrency);

                const monthlySummary = Array.isArray(dashboardData?.monthly_summary)
                    ? dashboardData.monthly_summary.slice(0, 6).reverse()
                    : [];

                const cashFlowTableEl = document.getElementById('cashFlowChart_table');
                const expensesTableEl = document.getElementById('expensesChart_table');
                if (cashFlowTableEl) cashFlowTableEl.innerHTML = '';
                if (expensesTableEl) expensesTableEl.innerHTML = '';

                if (monthlySummary.length) {
                    const labels = monthlySummary.map(item => `${formatMonthName(item.month)} ${item.year}`);
                    const incomeSeries = monthlySummary.map(item => Number(item.total_entradas || 0));
                    const nationalFundSeries = monthlySummary.map(item => Number(item.total_fondo_nacional || 0));

                    cashFlowChartInstance = ABSD.Charts.createChart('cashFlowChart', 'line', {
                        labels,
                        datasets: [
                            {
                                label: 'Entradas totales',
                                data: incomeSeries,
                                fill: false
                            },
                            {
                                label: 'Fondo Nacional',
                                data: nationalFundSeries,
                                fill: false
                            }
                        ]
                    }, {
                        title: 'Flujo de Caja (últimos 6 meses)',
                        isCurrency: true,
                        showLegend: true
                    });
                }

                const ledgerExpenses = Array.isArray(ledgerData?.gastos?.detalle_por_categoria)
                    ? ledgerData.gastos.detalle_por_categoria
                    : [];

                const expenseSource = ledgerExpenses.length ? ledgerExpenses : (Array.isArray(dashboardData?.status_counts) ? dashboardData.status_counts : []);

                if (expenseSource.length) {
                    const labels = ledgerExpenses.length
                        ? ledgerExpenses.map(item => formatCategory(item.categoria))
                        : expenseSource.map(item => formatStatus(item.estado));

                    const values = ledgerExpenses.length
                        ? ledgerExpenses.map(item => Number(item.total_monto || 0))
                        : expenseSource.map(item => Number(item.count || 0));

                    expensesChartInstance = ABSD.Charts.createChart('expensesChart', ledgerExpenses.length ? 'doughnut' : 'bar', {
                        labels,
                        datasets: [
                            {
                                label: ledgerExpenses.length ? 'Monto' : 'Reportes',
                                data: values
                            }
                        ]
                    }, {
                        title: ledgerExpenses.length ? 'Gastos por categoría' : 'Estados de informes',
                        isCurrency: !!ledgerExpenses.length,
                        showLegend: ledgerExpenses.length > 0,
                        legendPosition: 'right'
                    });
                }

                chartPanels.forEach(panel => ABSD.pipeline.hideSkeleton(panel));

            } catch (error) {
                console.error('Error al cargar el dashboard de la iglesia', error);
                metricCards.forEach(card => ABSD.pipeline.hideSkeleton(card));
                chartPanels.forEach(panel => ABSD.pipeline.hideSkeleton(panel));
                notify('No se pudo cargar el panel principal', 'error');
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-PY', {
                style: 'currency',
                currency: 'PYG',
                minimumFractionDigits: 0
            }).format(value || 0);
        }

        function escapeHtml(value) {
            if (value === undefined || value === null) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDateTime(value) {
            if (!value) return 'N/D';
            return new Date(value).toLocaleString('es-PY');
        }

        function formatMonthName(month) {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[(month - 1 + 12) % 12] || 'Mes';
        }

        function formatStatus(status) {
            const map = {
                pendiente: 'Pendiente',
                procesado: 'Procesado',
                borrador: 'Borrador',
                eliminado: 'Eliminado'
            };
            return map[status] || status;
        }

        function formatCategory(category) {
            const normalized = (category || '').toString().toLowerCase();
            const map = {
                servicios_basicos: 'Servicios básicos',
                honorarios: 'Honorarios pastorales',
                ministerio: 'Ministerio',
                materiales: 'Materiales',
                mantenimiento: 'Mantenimiento',
                otros: 'Otros gastos'
            };
            if (map[normalized]) {
                return map[normalized];
            }
            return normalized
                ? normalized.charAt(0).toUpperCase() + normalized.slice(1).replace(/_/g, ' ')
                : 'Otros';
        }

        function statusChipClasses(status) {
            switch (status) {
            case 'procesado':
                return 'bg-green-100 text-green-700';
            case 'borrador':
                return 'bg-gray-100 text-gray-600';
            case 'pendiente':
                return 'bg-yellow-100 text-yellow-700';
            default:
                return 'bg-blue-100 text-blue-700';
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            document.getElementById('loginText').textContent = 'Iniciando...';
            document.getElementById('loginLoading').classList.remove('hidden');

            try {
                const response = await axios.post(`${API_BASE}${API_ENDPOINTS.auth}?action=login`, { email, password });
                const { token, user } = response.data || {};

                setAuthToken(token);
                currentUser = user || null;
                currentChurch = user?.churchId ? {
                    id: user.churchId,
                    name: user.churchName || 'Iglesia IPUPY'
                } : null;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = currentUser?.email || '';
                if (currentChurch?.name) {
                    document.getElementById('churchName').textContent = currentChurch.name;
                }

                await initializeApp();
            } catch (error) {
                notify(error.response?.data?.error || 'Credenciales inválidas', 'error');
            } finally {
                document.getElementById('loginText').textContent = 'Iniciar Sesión';
                document.getElementById('loginLoading').classList.add('hidden');
            }
        });

        document.getElementById('startReportWizardBtn').addEventListener('click', openReportWizard);
        document.getElementById('closeReportWizardBtn').addEventListener('click', closeReportWizard);
        document.getElementById('reportWizardBackBtn').addEventListener('click', () => {
            if (!reportWizardState) return;
            if (reportWizardState.step > 1) {
                reportWizardState.step -= 1;
                updateWizardUI();
            }
        });
        document.getElementById('reportWizardNextBtn').addEventListener('click', async () => {
            if (!reportWizardState) return;
            const currentStep = reportWizardState.step;
            if (!validateWizardStep(currentStep)) return;
            if (currentStep === REPORT_WIZARD_STEPS.length) {
                await submitReportWizard(false);
            } else {
                reportWizardState.step += 1;
                updateWizardUI();
            }
        });
        document.getElementById('reportWizardSaveDraftBtn').addEventListener('click', async () => {
            if (!validateWizardStep(REPORT_WIZARD_STEPS.length)) return;
            await submitReportWizard(true);
        });

        document.getElementById('wizardResumenFile').addEventListener('change', () => handleWizardFileChange('wizardResumenFile', 'summary'));
        document.getElementById('wizardDepositoFile').addEventListener('change', () => handleWizardFileChange('wizardDepositoFile', 'deposit'));

        ['wizardDiezmos', 'wizardOfrendas', 'wizardAnexos', 'wizardCaballeros', 'wizardDamas', 'wizardJovenes', 'wizardNinos', 'wizardOtros', 'wizardHonorariosPastoral', 'wizardServicios', 'wizardMontoDepositado']
            .forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateWizardTotals);
                }
            });

        document.getElementById('reportYearFilter').addEventListener('change', renderReportList);

        async function initializeApp() {
            if (!currentUser) {
                await restoreUserContext();
            }
            await loadDashboardData();
            await loadMyReports();
            showSection('dashboard');
        }

        window.addEventListener('load', async () => {
            enhanceFormControls();
            const storedToken = getStoredToken();
            if (storedToken) {
                setAuthToken(storedToken);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                await initializeApp();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
