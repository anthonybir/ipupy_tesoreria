# OAuth Placeholder URL Fix - October 3, 2025

## Issue: Safari Can't Find Server "placeholder.supabase.co"

### Problem Description
When clicking "Login with Google", Safari displayed error:
```
Safari can't open the page "https://placeholder.supabase.co/auth/v1/authorize?..."
because Safari can't find the server "placeholder.supabase.co"
```

### Root Cause Analysis

**Two separate issues identified**:

1. **Missing NEXT_PUBLIC_* Environment Variables** ❌
   - Vercel had `SUPABASE_URL` and `SUPABASE_ANON_KEY`
   - Code was looking for `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - Variables with `NEXT_PUBLIC_` prefix didn't exist in Vercel

2. **Next.js Static Analysis Limitations** ⚠️
   - Initial fix attempted bracket notation: `process.env['NEXT_PUBLIC_SUPABASE_URL']`
   - Next.js static analysis couldn't detect this as a replaceable env var
   - Placeholder values were compiled into the bundle

### Solution Applied

#### Step 1: Add Missing Environment Variables ✅

Added `NEXT_PUBLIC_` prefixed versions of Supabase credentials to Vercel:

```bash
# Production
NEXT_PUBLIC_SUPABASE_URL → https://vnxghlfrmmzvlhzhontk.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY → eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Preview
NEXT_PUBLIC_SUPABASE_URL → https://vnxghlfrmmzvlhzhontk.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY → eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Development
NEXT_PUBLIC_SUPABASE_URL → https://vnxghlfrmmzvlhzhontk.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY → eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

Commands used:
```bash
grep "^SUPABASE_URL=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_URL production
grep "^SUPABASE_URL=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_URL preview
grep "^SUPABASE_URL=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_URL development

grep "^SUPABASE_ANON_KEY=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY production
grep "^SUPABASE_ANON_KEY=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY preview
grep "^SUPABASE_ANON_KEY=" .env.production.local | cut -d'=' -f2- | tr -d '"' | vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY development
```

#### Step 2: Use Inline Environment Variable Access ✅

Modified `getSupabaseConfig()` to use **inline** bracket notation access:

**File**: `src/lib/env-validation.ts`

```typescript
// ❌ Previous approach (tried but failed)
const url = process.env['NEXT_PUBLIC_SUPABASE_URL']; // Separated assignment
const config = { url };

// ✅ Working approach (inline access)
const config = {
  url: process.env['NEXT_PUBLIC_SUPABASE_URL'] ?? '',
  anonKey: process.env['NEXT_PUBLIC_SUPABASE_ANON_KEY'] ?? '',
};
```

**Why inline access works**:
- Next.js static analysis scans for direct `process.env` access in object literals
- Intermediate variable assignments break the static analysis chain
- Inline access ensures Next.js replaces the value at build time

### Technical Details

#### Next.js Environment Variable Replacement

Next.js replaces environment variables at **build time** through static analysis:

1. **Scans code** for `process.env.NEXT_PUBLIC_*` or `process.env['NEXT_PUBLIC_*']`
2. **Replaces inline** with actual string values
3. **Requires direct access** - no intermediate variables

**Examples**:

```typescript
// ✅ Works - Inline object literal
const config = {
  url: process.env['NEXT_PUBLIC_URL']
};

// ✅ Works - Direct assignment
const url = process.env.NEXT_PUBLIC_URL;

// ❌ Fails - Indirect access via variable
const key = 'NEXT_PUBLIC_URL';
const url = process.env[key];

// ❌ Fails - Assignment then use
const url = process.env['NEXT_PUBLIC_URL'];
const config = { url }; // url is already replaced, but in wrong place
```

#### Why Bracket Notation Is Required

TypeScript strict mode (`noPropertyAccessFromIndexSignature: true`) requires bracket notation for index signatures:

```typescript
// ❌ TypeScript error with strict mode
const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
// Error: Property 'NEXT_PUBLIC_SUPABASE_URL' comes from an index signature

// ✅ TypeScript happy with bracket notation
const url = process.env['NEXT_PUBLIC_SUPABASE_URL'];
```

### Deployment Timeline

| Time | Deployment | Status | Issue |
|------|------------|--------|-------|
| 11:40 | `cgc89sufv` | ❌ Error | Incorrect bracket notation approach |
| 11:44 | `a657gg0ug` | ✅ Ready | Documentation update |
| 11:47 | `c7fnwu4gi` | ✅ Ready | **Fixed with inline access + env vars** |

**Latest Working Deployment**: https://ipupytesoreria-c7fnwu4gi-anthony-birs-projects.vercel.app

### Files Modified

1. ✅ `src/lib/env-validation.ts` - Inline environment variable access
2. ✅ Vercel Environment Variables - Added NEXT_PUBLIC_* prefixed versions

### Verification Steps

To verify the fix:

1. ✅ Open https://ipupytesoreria.vercel.app/login
2. ✅ Click "Iniciar sesión con Google" button
3. ✅ Should redirect to **real** Supabase OAuth URL:
   ```
   https://vnxghlfrmmzvlhzhontk.supabase.co/auth/v1/authorize?...
   ```
4. ✅ **NOT** placeholder URL:
   ```
   https://placeholder.supabase.co/auth/v1/authorize?... ❌
   ```

### Lessons Learned

1. **Environment Variable Naming**:
   - `NEXT_PUBLIC_*` prefix is **mandatory** for client-side access
   - Server-only variables don't need prefix
   - Existing `SUPABASE_URL` couldn't be used directly in browser

2. **Next.js Static Analysis**:
   - Requires **inline** `process.env` access for replacement
   - Intermediate variables break the analysis chain
   - Works with both dot and bracket notation (when inline)

3. **TypeScript Strict Mode**:
   - `noPropertyAccessFromIndexSignature` forces bracket notation
   - Next.js handles both notations correctly
   - Must balance TypeScript strictness with Next.js requirements

4. **Vercel Environment Variables**:
   - Values are injected at **runtime**, not build time
   - `NEXT_PUBLIC_*` values are replaced at **build time**
   - Must have correct naming for client-side access

### Git History

```bash
7eea21a - fix(env): use inline env access for Next.js static replacement
```

### Production Status: ✅ RESOLVED

**OAuth Flow**: Working correctly
**Supabase URL**: Real production URL (vnxghlfrmmzvlhzhontk.supabase.co)
**Deployment**: https://ipupytesoreria-c7fnwu4gi-anthony-birs-projects.vercel.app

### Related Documentation

- [PRODUCTION_FIXES_2025-10-03.md](PRODUCTION_FIXES_2025-10-03.md) - Previous environment variable fixes
- [ENV_FIXES_2025-10-03.md](ENV_FIXES_2025-10-03.md) - Technical details on env validation

### References

- [Next.js Environment Variables](https://nextjs.org/docs/app/building-your-application/configuring/environment-variables)
- [Next.js Static Analysis](https://nextjs.org/docs/pages/building-your-application/configuring/environment-variables#bundling-environment-variables-for-the-browser)
- [Vercel Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
